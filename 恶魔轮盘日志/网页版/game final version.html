<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buckshot Reborn - Full Integrated Edition</title>
    <style>
/* =========================================
   1. style.css åŸå§‹å†…å®¹
   ========================================= */
html {
    font-size: 20px; 
}

@media (max-width: 600px) {
    html {
        font-size: 16px;
    }
}

:root {
    --bg-dark: #050505;
    --panel-bg: #1a1a1a;
    --text-main: #e0e0e0;
    --accent-green: #2ecc71;
    --accent-red: #ff4757;
    --accent-blue: #1e90ff;
    --accent-gold: #ffa502;
    --accent-purple: #a55eea;
    --accent-cursed: #ff6b81;
    --accent-grey: #7f8c8d;
    --accent-shield: #3498db;
    --accent-poison: #00b894;
}

body {
    background: #000;
    color: var(--text-main);
    font-family: 'Segoe UI', 'Roboto', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
    overflow: hidden;
    user-select: none;
}

#game-container {
    width: 100%;
    max-width: 600px;
    height: 100vh;
    background-color: #111;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
    position: relative;
    perspective: 800px;
    border: 2px solid #111;
    transition: border-color 0.5s;
}

#menu-screen {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(10, 10, 10, 0.98);
    z-index: 300;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.top-bar-btn {
    position: absolute; top: 20px;
    background: transparent;
    border: 1px solid #444;
    color: #888;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: 0.2s;
}
.top-bar-btn:hover { border-color: #fff; color: #fff; }
#lang-btn { right: 20px; }
#achieve-btn { left: 20px; border-color: var(--accent-gold); color: var(--accent-gold); }

#settings-btn {
    position: absolute; top: 15px; right: 15px; z-index: 100;
    background: #222; border: 1px solid #444; color: #ccc;
    width: 35px; height: 35px; border-radius: 50%;
    cursor: pointer; font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center; 
    transition: 0.2s;
}
#settings-btn:hover { background: #444; color: #fff; border-color: #fff; transform: rotate(90deg); }

.menu-btn {
    background: linear-gradient(180deg, #333, #222);
    border: 1px solid #555;
    color: #fff;
    padding: 15px 40px;
    font-size: 1.1rem;
    margin: 8px;
    cursor: pointer;
    width: 80%;
    border-radius: 8px;
    font-weight: bold;
    transition: 0.2s;
    box-shadow: 0 4px 0 #111;
}
.menu-btn:active { transform: translateY(4px); box-shadow: none; }
.menu-btn:hover { border-color: #888; background: #444; }

.menu-btn.continue {
    border-color: var(--accent-green); color: var(--accent-green); 
    background: linear-gradient(180deg, #1a3320, #0d1a10); 
}
.menu-btn.danger {
    border-color: var(--accent-red); color: var(--accent-red); 
    background: linear-gradient(180deg, #331a1a, #1a0d0d); 
}
.menu-btn.info {
    border-color: var(--accent-blue); color: var(--accent-blue); 
    background: linear-gradient(180deg, #1a2533, #0d121a); 
}

#twist-toggle {
    margin-bottom: 20px; cursor: pointer; padding: 12px 25px;
    border: 2px solid #333; border-radius: 8px; color: #666; font-weight: bold;
    transition: 0.3s; display: flex; align-items: center; gap: 10px;
}
#twist-toggle.active {
    border-color: var(--accent-cursed); background: rgba(214, 48, 49, 0.1); color: var(--accent-cursed); 
}
.checkbox-fake { width: 18px; height: 18px; border: 2px solid currentColor; border-radius: 4px; display: inline-block; position: relative; }
#twist-toggle.active .checkbox-fake::after { content:'âœ”'; position:absolute; top:-3px; left:2px; font-size:14px; }

.modal-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 400;
    display: none;
    flex-direction: column; align-items: center; justify-content: center;
    animation: fadeIn 0.3s;
}

.talent-container { display: flex; gap: 10px; width: 98%; justify-content: center; align-items: stretch; }

.talent-card {
    background: #222; border: 1px solid #444; 
    width: 32%;
    padding: 20px 10px; border-radius: 8px;
    cursor: pointer; text-align: center; transition: 0.2s;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: auto; min-height: 160px; position: relative;
}
.talent-card:hover {
    border-color: var(--accent-green); background: #2a2a2a; transform: translateY(-5px); 
}
.talent-icon { font-size: 2.5rem; margin-bottom: 10px; }
.talent-title { color: var(--accent-green); font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; text-transform: uppercase;}
.talent-desc { color: #aaa; font-size: 0.75rem; line-height: 1.4; word-wrap: break-word; }

.curse-card {
    background: #1a0505; border: 1px solid #500; width: 32%; padding: 20px 10px; border-radius: 8px;
    cursor: pointer; text-align: center; transition: 0.2s; color: #fff;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.curse-card:hover { 
    border-color: var(--accent-cursed); background: #2a0a0a; 
    transform: translateY(-5px); box-shadow: 0 0 15px rgba(255, 71, 87, 0.2); 
}
.curse-title { color: var(--accent-cursed); font-weight: bold; margin-bottom: 10px; text-transform: uppercase; font-size: 0.9rem; }
.curse-desc { font-size: 0.75rem; color: #aaa; line-height: 1.4; }

.top-info-bar { 
    display: flex; justify-content: space-between; align-items: stretch; 
    margin-bottom: 10px; gap: 10px; margin-top: 25px;
}

.boss-area { flex: 2; display:flex; flex-direction:column; gap:5px; }

.boss-card { 
    flex: 1; min-height: 60px;
    background: #1a1a1a; border-left: 4px solid var(--accent-red);
    padding: 10px 15px; border-radius: 4px; 
    display: flex; flex-direction: column; justify-content: center; position: relative;
}
.boss-card.enraged {
    background: #300; border-color: #f00; box-shadow: inset 0 0 20px #500;
}
.boss-name { font-size: 1rem; font-weight: 800; color: var(--accent-red); letter-spacing: 1px;}
.boss-passive { font-size: 0.7rem; color: #666; }

#enemy-items-display {
    display: flex; gap: 4px; padding: 0 5px; min-height: 25px; align-items: center;
}
.enemy-item-icon {
    width: 24px; height: 24px; background: #222; border: 1px solid #444; color: #aaa;
    border-radius: 4px; display: flex; align-items: center; justify-content: center;
    font-size: 14px; position: relative; cursor: help;
}
.enemy-item-icon:hover { border-color: var(--accent-red); color: #fff; background: #333; }

.enemy-item-tooltip {
    visibility: hidden; opacity: 0; width: 140px; background: rgba(0,0,0,0.95);
    border: 1px solid var(--accent-red); color: #fff; padding: 8px; border-radius: 4px;
    position: absolute; top: 100%; left: 0; z-index: 200; pointer-events: none;
    font-size: 0.7rem; text-align: left; transition: 0.2s;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.enemy-item-icon:hover .enemy-item-tooltip { visibility: visible; opacity: 1; }

#boss-taunt {
    position: absolute; bottom: -35px; left: 10px; 
    background: #fff; color: #000;
    padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;
    opacity: 0; transition: 0.3s; pointer-events: none; white-space: nowrap; z-index: 50;
}
#boss-taunt::before {
    content:''; position: absolute; top:-5px; left:10px; 
    border-width:0 5px 5px; border-style:solid; border-color: transparent transparent #fff; 
}
#boss-taunt.show { opacity: 1; transform: translateY(-5px); }

.event-bar { 
    flex: 1;
    background: #1a1a1a; border: 1px solid #333; border-radius: 4px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    position: relative; cursor: help; 
}
.event-val { font-size: 0.8rem; color: var(--accent-gold); font-weight: bold; text-align: center; line-height: 1; }
.event-tooltip { 
    visibility: hidden; opacity: 0; width: 180px; 
    background: rgba(0,0,0,0.95); border: 1px solid var(--accent-gold); color: #fff; 
    padding: 10px; border-radius: 6px; 
    position: absolute; top: 110%; right: 0; z-index: 100; 
    transition: 0.2s; pointer-events: none; text-align: left; 
}
.event-bar:hover .event-tooltip { visibility: visible; opacity: 1; }

#table-area { 
    flex-grow: 1; flex-shrink: 1;
    min-height: 120px; 
    background: radial-gradient(#222, #111);
    border-radius: 12px; border: 1px solid #333; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    margin-bottom: 10px; position: relative; transition: border-color 0.3s;
}

#gun-display { 
    font-size: 5rem; margin-bottom: 5px; 
    transition: transform 0.1s ease-out; 
    filter: drop-shadow(0 15px 15px rgba(0,0,0,0.6));
    transform-style: preserve-3d; cursor: crosshair;
}

#ammo-tracker { 
    font-family: 'Courier New', monospace;
    font-weight: bold; font-size: 1.1rem; color: #fff; 
    background: rgba(0,0,0,0.6); padding: 5px 20px; 
    border-radius: 20px; border: 1px solid #555; letter-spacing: 2px; 
}
.fog-text { letter-spacing: 0px !important; color: #888 !important; }

#history-display { display: flex; gap: 6px; margin-top: 5px; height: 20px; align-items: center; opacity: 0.8; }
.hist-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #555; }
.hist-live { background: var(--accent-red); border-color: var(--accent-red); box-shadow: 0 0 5px var(--accent-red); }
.hist-blank { background: #555; border-color: #888; }
.hist-unknown { background: transparent; border: 0; color: var(--accent-gold); font-weight: bold; font-size: 12px; line-height: 12px; }
.hist-hidden .hist-live, .hist-hidden .hist-blank { background: #333 !important; border-color: #444 !important; box-shadow: none !important; }

#chamber-display { display: flex; gap: 8px; margin-top: 5px; height: 30px; }
.shell { 
    width: 20px; height: 20px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; font-size: 0.7rem; 
    border: 1px solid #444; background: #222; color: #666; transition:0.3s; 
}
.shell.live { border-color: var(--accent-red); background: #c0392b; color: #000;}
.shell.blank { border-color: var(--accent-blue); background: #2980b9; color: #fff;}
.fog-active .shell.live, .fog-active .shell.blank { background: #444 !important; border-color: #666 !important; color: transparent !important; }

#info-text { 
    color: var(--accent-gold); text-align: center; font-size: 0.95rem; font-weight: bold; 
    padding: 0 20px; min-height: 40px; display: flex; align-items: center; justify-content: center; 
    margin-top: 10px; 
}

#items-area {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 100%;
    height: auto;
    min-height: 80px;
    overflow: visible;
    padding: 10px;
    box-sizing: border-box;
    background: rgba(0, 0, 0, 0.3);
    border-top: 1px solid #333;
    z-index: 100;
}

.item-btn { 
    flex: none;
    width: 60px; height: 60px;
    background: #222; 
    border: 1px solid #444; 
    border-radius: 6px; 
    position: relative; 
    cursor: pointer; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    transition: 0.2s;
}

.item-icon { font-size: 1.6rem; margin-bottom: 0; }
.item-name { font-size: 0.5rem; color: #888; margin-top: 2px; transform: scale(0.9); }
.item-badge {
    position: absolute; top: -5px; right: -5px; 
    background: var(--accent-blue); color: #fff; 
    font-size: 0.7rem; font-weight: bold; width: 18px; height: 18px; 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
    border: 2px solid #111; 
}
.item-btn:hover:not(:disabled) { background: #333; border-color: #666; transform: translateY(-2px); z-index: 10; }
.item-btn:disabled { opacity: 0.2; filter: grayscale(1); }

.item-tooltip { 
    visibility: hidden; opacity: 0; 
    width: 180px; 
    background: rgba(10, 10, 10, 0.98); color: #e0e0e0; 
    border: 1px solid var(--accent-gold); 
    border-radius: 6px; padding: 10px; 
    position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
    z-index: 1000; pointer-events: none;
    transition: 0.2s; text-align: center; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.8);
}
.item-btn:hover .item-tooltip { visibility: visible; opacity: 1; bottom: 120%; }
.item-tooltip h4 { margin: 0 0 5px 0; color: var(--accent-gold); font-size: 0.9rem; text-transform: uppercase; }
.item-tooltip p { margin: 0; font-size: 0.75rem; color: #ccc; line-height: 1.4; }
.item-deceptive { filter: grayscale(1) opacity(0.6); }

.demon-area-hover {
    cursor: help;
    position: relative;
}

.demon-talent-tooltip {
    visibility: hidden; 
    opacity: 0; 
    position: absolute; 
    bottom: 100%;
    left: 0;
    background: rgba(20, 5, 5, 0.98);
    border: 1px solid var(--accent-red);
    padding: 10px; 
    width: 220px;
    border-radius: 8px; 
    z-index: 100;
    transition: 0.2s; 
    pointer-events: none; 
    text-align: left;
    margin-bottom: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

.demon-area-hover:hover .demon-talent-tooltip { 
    visibility: visible; 
    opacity: 1; 
    transform: translateY(-5px);
}

#bottom-panel { display: flex; flex-direction: column; gap: 8px; }

.hp-container { display: flex; justify-content: space-between; padding: 0 5px; position: relative; align-items: flex-end;}
.hp-label { font-size: 0.7rem; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;}
.hp-bar { display: flex; gap: 4px; }
.hp-point { width: 14px; height: 10px; background: #333; border-radius: 2px; box-shadow: inset 0 0 2px #000; }
.hp-point.demon-active { background: var(--accent-red); box-shadow: 0 0 5px var(--accent-red); }
.hp-point.you-active { background: var(--accent-green); box-shadow: 0 0 5px var(--accent-green); }
.hp-point.shielded { border: 2px solid var(--accent-shield); box-sizing: border-box; }

.lives-wrapper { display: flex; gap: 5px; margin-bottom: 5px; font-size: 0.9rem; }
.life-heart { color: #555; transition: 0.3s; }
.life-active { color: #ff4757; text-shadow: 0 0 5px #ff4757; }

.you-area-hover { cursor: help; }
.my-talent-tooltip {
    visibility: hidden; opacity: 0; position: absolute; bottom: 100%; right: 0;
    background: rgba(10,10,10,0.98); border: 1px solid var(--accent-green);
    padding: 10px; width: 200px; border-radius: 8px; z-index: 100;
    transition: 0.2s; pointer-events: none; text-align: left;
    margin-bottom: 10px;
}
.you-area-hover:hover .my-talent-tooltip { visibility: visible; opacity: 1; }

#controls { display: flex; gap: 10px; height: 60px; }
.action-btn { 
    flex: 1;
    border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; 
    cursor: pointer; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; 
    overflow: visible; transition: 0.1s;
}
.btn-self { background: linear-gradient(135deg, #27ae60, #2ecc71); }
.btn-enemy { background: linear-gradient(135deg, #c0392b, #e74c3c); }
.action-btn:disabled { background: #222 !important; color: #444 !important; }
.action-btn small { font-size: 0.7rem; opacity: 0.7; font-weight: normal; margin-top:2px;}
.cursed-btn { background: linear-gradient(135deg, #8e44ad, #2c3e50) !important; border: 2px solid #9b59b6 !important; animation: glitch 0.5s infinite; }
@keyframes glitch { 0% { transform: translate(0,0); } 20% { transform: translate(-2px, 1px); } 100% { transform: translate(0,0); } }

#event-splash { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0, 0, 0, 0.95); z-index: 250; 
    display: none; flex-direction: column; align-items: center; justify-content: center; 
    animation: fadeIn 0.3s; 
}
.event-splash-card { 
    width: 80%; height: 40%; background: linear-gradient(135deg, #1a1a1a, #000); 
    border: 2px solid var(--accent-gold); border-radius: 12px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    box-shadow: 0 0 60px rgba(241, 196, 15, 0.3); 
    transform: scale(0.8); animation: popIn 0.5s forwards; 
}
@keyframes popIn { to { transform: scale(1); } }
.splash-title { color: var(--accent-gold); font-size: 2rem; font-weight: 900; margin-bottom: 15px; text-transform: uppercase; text-shadow: 0 0 10px black; text-align: center;}
.splash-desc { color: #ccc; font-size: 1rem; text-align: center; padding: 0 20px; line-height: 1.5; }

#toast-area {
    position: absolute; bottom: 120px; right: 20px;
    display: flex; flex-direction: column; gap: 10px; z-index: 600; pointer-events: none;
}
.toast-card {
    background: rgba(20, 20, 20, 0.95); border-left: 4px solid var(--accent-gold);
    color: #fff; padding: 12px 20px; border-radius: 4px; display: flex; align-items: center; gap: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: toastSlideIn 0.4s ease-out;
    min-width: 200px; backdrop-filter: blur(5px);
}
.toast-icon { font-size: 1.5rem; }
.toast-info { display: flex; flex-direction: column; }
.toast-title { font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: bold; }
.toast-name { font-size: 1rem; color: var(--accent-gold); font-weight: bold; }
@keyframes toastSlideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes toastFadeOut { to { transform: translateY(-10px); opacity: 0; } }

.settings-content { 
    background: #1a1a1a; border: 1px solid #444; padding: 25px; 
    border-radius: 12px; width: 80%; max-width: 320px; 
    display: flex; flex-direction: column; gap: 15px; align-items: center; 
    box-shadow: 0 0 40px rgba(0,0,0,0.8); 
}
.setting-row { display: flex; justify-content: space-between; align-items: center; width: 100%; color: #ddd; font-weight: bold; }
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; border: 1px solid #555; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent-green); border-color: var(--accent-green); }
input:checked + .slider:before { transform: translateX(24px); }

.shaking { animation: shake 0.3s; }
@keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-3px, -2px); } 100% { transform: translate(0, 0); } }
.flash-red { animation: flash 0.2s; }
@keyframes flash { 0% { background: rgba(255,0,0,0.3); } 100% { background: transparent; } }

#achieve-popup { 
    position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
    background: linear-gradient(90deg, #ffcc00, #ffaa00); color: #000; 
    padding: 8px 25px; border-radius: 50px; font-weight: bold; 
    box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 500; 
    display: none; align-items: center; gap: 10px; animation: slideDown 0.5s; 
}
@keyframes slideDown { from { top: -50px; } to { top: 20px; } }

.achieve-list { width: 90%; max-height: 60%; overflow-y: auto; display: grid; grid-template-columns: 1fr; gap: 8px; padding: 10px; }
.achieve-item { background: #1a1a1a; border: 1px solid #333; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 15px; opacity: 0.5; filter: grayscale(1); }
.achieve-item.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--accent-gold); background: rgba(255, 215, 0, 0.05); }
.ach-icon { font-size: 1.5rem; } .ach-info { display:flex; flex-direction:column; gap:2px; } .ach-info div:first-child { font-weight:bold; color:#ddd; font-size:0.8rem; } .ach-info div:last-child { font-size:0.65rem; color:#888; }

#help-content { width: 90%; height: 85%; overflow-y: auto; background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 8px; box-sizing: border-box; text-align: left; }
.help-section { margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 15px; }
.help-h2 { color: var(--accent-gold); font-size: 1.4rem; margin-top: 0; margin-bottom: 15px; border-left: 4px solid var(--accent-gold); padding-left: 10px; }
.help-p { color: #aaa; font-size: 0.9rem; line-height: 1.6; margin: 5px 0; }

#overlay { background: rgba(0,0,0,0.98) !important; z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; }
#win-title { font-size: 4rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 30px currentColor; text-align: center; }
#win-comment { font-size: 1rem; color: #aaa; margin-bottom: 20px; font-style: italic; text-align: center; max-width: 80%; }
#win-desc { font-size: 1.2rem; color: #fff; margin-bottom: 30px; text-align: center; }
.card { background: #222; color: #fff; border: 1px solid #555; border-radius: 8px; padding: 20px 10px; width: 30%; cursor: pointer; text-align: center; transition: 0.2s; }
.card:hover { border-color: var(--accent-gold); background: #333; transform: scale(1.05); }
#restart-btn { display: none; margin-top: 20px; font-size: 1rem; padding: 15px 40px; width: auto; border: 1px solid #555; background: #222; color: #fff; border-radius: 50px; cursor: pointer; transition: 0.2s; }
#restart-btn:hover { background: #fff; color: #000; }

#dice-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 350; display: none;
    flex-direction: column; align-items: center; justify-content: center;
}
.dice-area { display: flex; gap: 40px; margin-bottom: 20px; }
.dice-group { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.die-box { display: flex; gap: 10px; }
.die { width: 50px; height: 50px; background: #fff; border-radius: 8px; color: #000; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px #000; }
.die-p2 { background: #e74c3c; color: #fff; }
.die-p1 { background: #2ecc71; color: #000; }
.roll-res { font-size: 1.5rem; font-weight: bold; color: #fff; min-height: 30px;}

.rr-mode-active #table-area { border: 2px solid var(--accent-cursed); animation: pulseRed 1s infinite alternate; }
@keyframes pulseRed { from { box-shadow: 0 0 10px #500; } to { box-shadow: 0 0 30px #f00; } }
.rr-splash { font-size: 3rem; color: var(--accent-cursed); font-weight: 900; text-transform: uppercase; animation: shake 0.5s; text-shadow: 0 0 20px #f00; text-align: center;}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#mirror-overlay {
    position: absolute;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 150;
    display: none;
    cursor: pointer;
    animation: fadeIn 0.3s;
}

.mirror-active-target {
    z-index: 160 !important;
    position: relative;
    background: rgba(165, 94, 234, 0.2) !important;
    box-shadow: 0 0 20px var(--accent-purple), inset 0 0 10px var(--accent-purple);
    border: 2px dashed var(--accent-purple) !important;
    border-radius: 8px;
    padding: 10px !important;
    transition: 0.3s;
    pointer-events: auto !important;
    animation: pulse 1.5s infinite;
}

.starter-select-btn {
    width: 60px; height: 60px;
    background: #1a1a1a; border: 1px solid #444; border-radius: 6px;
    cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: 0.2s; opacity: 0.7;
}

.starter-select-btn.selected {
    border: 2px solid var(--accent-blue);
    background: #222;
    opacity: 1;
    box-shadow: 0 0 10px rgba(30, 144, 255, 0.3);
    transform: scale(1.1);
}

.starter-select-btn.dimmed {
    opacity: 0.3;
    pointer-events: none;
}

.top-bar-btn:active {
    transform: translateY(2px);
    opacity: 0.8;
}

.sicbo-content {
    background: radial-gradient(circle, #2c3e50, #000);
    border: 2px solid var(--accent-gold);
    padding: 30px; border-radius: 12px; width: 85%; max-width: 400px;
    text-align: center; box-shadow: 0 0 50px rgba(255, 165, 0, 0.2);
    animation: popIn 0.4s;
}
.sicbo-dice-area {
    display: flex; justify-content: center; gap: 15px; margin-top: 20px;
}
.sicbo-actions {
    display: flex; gap: 10px; margin-top: 10px;
}
.sicbo-actions .menu-btn {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 15px 5px; font-size: 1rem;
}
.triple-kill {
    animation: shake 0.5s infinite;
    border-color: var(--accent-red) !important;
    background: #300 !important;
}

body::before {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
    opacity: 0.15;
    pointer-events: none;
    z-index: 900;
}

body::after {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0),
        rgba(255, 255, 255, 0) 50%,
        rgba(0, 0, 0, 0.2) 50%,
        rgba(0, 0, 0, 0.2)
    );
    background-size: 100% 4px;
    pointer-events: none;
    z-index: 901;
    animation: scanlineMove 10s linear infinite;
}

#game-container {
    box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
}


@keyframes scanlineMove {
    0% { background-position: 0 0; }
    100% { background-position: 0 100%; }
}

@keyframes violent-shake {
    0% { transform: translate(0, 0) rotate(0); }
    10% { transform: translate(-10px, -10px) rotate(-2deg); }
    20% { transform: translate(10px, 10px) rotate(2deg); }
    30% { transform: translate(-8px, 8px) rotate(0); }
    40% { transform: translate(8px, -8px) rotate(1deg); }
    50% { transform: translate(-5px, 0) rotate(0); }
    100% { transform: translate(0, 0); }
}
.big-shake {
    animation: violent-shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
}
    </style>
</head>
<body>
    <div id="game-container">
        
        <div id="mirror-overlay" onclick="cancelMirrorMode()">
            <div style="color:#fff; margin-top:20%">ç‚¹å‡»ä»»æ„å¤„å–æ¶ˆ</div>
        </div>

        <div id="menu-screen">
            <button id="achieve-btn" class="top-bar-btn" style="left:20px" onclick="showAchievements()">ğŸ† 0/30</button>
            <button id="lang-btn" class="top-bar-btn" onclick="toggleLanguage()">ğŸŒ EN / ä¸­</button>
            
            <h1 style="color:#e74c3c; font-size:3.5rem; margin-bottom:5px; text-align:center;">BUCKSHOT<br>REBORN</h1>
            <div id="subtitle-fix" style="color:#666; margin-bottom:30px;">Roulette Update</div>
            
            <div id="twist-toggle" onclick="toggleTwist()">
                <div class="checkbox-fake"></div> <span id="txt-twist">TWISTED MODE</span>
            </div>
            
            <button class="menu-btn continue" onclick="loadGame()" id="btn-continue" style="display:none;">â–¶ CONTINUE</button>
            <button class="menu-btn" onclick="preStartGame('pve')" id="btn-pve">ğŸ’€ å•äººæˆ˜å½¹</button>
            <button class="menu-btn" onclick="preStartGame('pvp')" id="btn-pvp">âš”ï¸ åŒäººå¯¹æˆ˜</button>
            <button class="menu-btn info" onclick="showHelp()">ğŸ“– ç©æ³•è¯´æ˜</button>
        </div>
        
        <div id="dice-overlay">
            <h2 style="color:var(--accent-gold); margin-bottom:30px;">INITIATIVE ROLL</h2>
            <div class="dice-area">
                <div class="dice-group">
                    <div style="color:var(--accent-green)">YOU</div>
                    <div class="die-box"><div class="die die-p1" id="d1-1">?</div><div class="die die-p1" id="d1-2">?</div></div>
                    <div class="roll-res" id="sum-p1"></div>
                </div>
                <div class="dice-group">
                    <div style="color:var(--accent-red)">ENEMY</div>
                    <div class="die-box"><div class="die die-p2" id="d2-1">?</div><div class="die die-p2" id="d2-2">?</div></div>
                    <div class="roll-res" id="sum-p2"></div>
                </div>
            </div>
            <div id="dice-msg" style="color:#aaa; font-size:1.2rem; min-height:30px;">Rolling...</div>
        </div>

        <div id="help-screen" class="modal-overlay">
            <div id="help-content">
                <h1 style="color:#fff; text-align:center; border-bottom:1px solid #333; padding-bottom:15px;">ğŸ“– æ¸¸æˆæŒ‡å—</h1>
                <div class="help-section">
                    <h2 class="help-h2">1. åŸºç¡€è§„åˆ™</h2>
                    <p class="help-p"><strong>ç›®æ ‡ï¼š</strong> è€—å°½å¯¹æ–¹çš„ç”Ÿå‘½å€¼ (HP)ã€‚</p>
                </div>
                <button class="menu-btn" style="width:100%; margin:10px 0 0 0;" onclick="closeHelp()">å…³é—­</button>
            </div>
        </div>

        <div id="talent-screen" class="modal-overlay">
            <h2 id="title-talent" style="color:#fff; margin-bottom:20px;">CHOOSE TALENT</h2>
            <div class="talent-container" id="talent-grid-box"></div>
        </div>

        <div id="pact-screen" class="modal-overlay">
            <h2 id="title-pact" style="color:var(--accent-cursed); margin-bottom:10px;">DARK PACT</h2>
            <p id="pact-desc" style="color:#999; margin-bottom:20px; font-size:0.8rem;">High Risk, High Reward.</p>
            <div class="talent-container" id="pact-grid-box"></div>
            <button id="btn-nodeal" class="top-bar-btn" style="position:static; margin-top:20px; border-color:#666; color:#666;" onclick="selectPact(null)">NO DEAL</button>
        </div>

        <div id="starter-item-screen" class="modal-overlay">
            <h2 style="color:var(--accent-blue); margin-bottom:10px;">SUPPLY DROP</h2>
            <p style="color:#aaa; margin-bottom:20px; font-size:0.9rem;">é€‰æ‹© 2 ä¸ªåˆå§‹é“å…·</p>
            <div id="starter-item-grid" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; max-width:90%;"></div>
            <div style="display:flex; gap:15px; margin-top:20px; width:100%; justify-content:center;">
                <button class="top-bar-btn" style="position:static; border-color:var(--accent-purple); color:var(--accent-purple); padding: 10px 20px; font-size: 1rem;" onclick="randomizeStarterItems()">ğŸ² RANDOM</button>
                <button id="btn-confirm-items" class="top-bar-btn" style="position:static; border-color:var(--accent-blue); color:var(--accent-blue); padding: 10px 30px; font-size: 1rem;" onclick="confirmStarterItems()">CONFIRM (0/2)</button>
            </div>
        </div>

        <div id="settings-screen" class="modal-overlay">
            <div class="settings-content">
                <h2 id="setting-paused" style="color:#fff; margin:0;">PAUSED</h2>
                <div class="setting-row">
                    <span id="txt-sound">Sound Effects</span>
                    <label class="switch"><input type="checkbox" id="sound-toggle" onchange="toggleSound()"><span class="slider"></span></label>
                </div>
                <hr style="width:100%; border:0; border-top:1px solid #444; margin:5px 0;">
                <button class="menu-btn" style="width:100%; margin:0; font-size:1rem;" onclick="closeSettings()">â–¶ RESUME</button>
                <button class="menu-btn" style="width:100%; margin:0; font-size:1rem;" onclick="exitGame()">ğŸ  MAIN MENU</button>
                <button class="menu-btn danger" style="width:100%; margin:0; font-size:1rem;" onclick="giveUpGame()">ğŸ³ï¸ GIVE UP</button>
            </div>
        </div>

        <div id="achieve-screen" class="modal-overlay">
            <h2 style="color:var(--accent-gold); margin-bottom:10px;">ACHIEVEMENTS</h2>
            <div class="achieve-list" id="achieve-list-container"></div>
            <button class="top-bar-btn" style="position:static; margin-top:15px; border-color:#fff; color:#fff;" onclick="closeAchieve()">CLOSE</button>
        </div>

        <div id="achieve-popup"><span style="font-size:1.5rem">ğŸ†</span><div><div style="font-size:0.7rem; text-transform:uppercase;">Unlocked</div><div id="achieve-pop-name" style="font-size:0.9rem;">...</div></div></div>
        <div id="event-splash"><div class="event-splash-card"><div class="splash-title" id="splash-title">EVENT</div><div class="splash-desc" id="splash-desc">...</div></div></div>
        <div id="toast-area"></div>

        <div id="overlay">
            <h2 id="win-title">VICTORY</h2>
            <div id="win-comment">"..."</div>
            <div id="win-desc">...</div>
            <div style="display:flex; width:100%; justify-content:center; gap:10px; flex-wrap:wrap;" id="card-display"></div>
            <button id="restart-btn" onclick="showMenu()">ğŸ  MAIN MENU</button>
        </div>

        <button id="settings-btn" onclick="openSettings()">âš™ï¸</button>
        
        <div class="top-info-bar">
            <div class="boss-area">
                <div class="boss-card" id="boss-card">
                    <div class="boss-name" id="boss-name-display">UNKNOWN</div>
                    <div class="boss-passive" id="boss-passive-display">...</div>
                    <div id="boss-taunt">You missed.</div> </div>
                <div id="enemy-items-display"></div>
            </div>
            <div class="event-bar">
                <div style="font-size:0.6rem; color:#555; font-weight:bold;">EVENT</div>
                <div class="event-val" id="active-event-name">NORMAL</div>
                <div class="event-tooltip"><h4 id="tooltip-event-title">Title</h4><p id="tooltip-event-desc">Description</p></div>
            </div>
        </div>

        <div id="table-area">
            <div id="gun-display">ğŸ”«</div>
            <div id="ammo-tracker">-- / --</div>
            <div id="history-display"></div> 
            <div id="chamber-display"></div> <div id="info-text">System Ready...</div> </div>

        <div id="items-area"></div>

        <div id="bottom-panel">
            <div class="hp-container">
                
                <div style="display:flex; flex-direction:column;" class="demon-area-hover">
                    <div class="lives-wrapper" id="lives-demon"></div>
                    <div class="hp-label" style="color:var(--accent-red);" id="label-demon">DEMON</div>
                    <div class="demon-talent-tooltip">
                        <strong style="color:var(--accent-red)" id="hover-demon-name">UNKNOWN</strong>
                        <hr style="border:0; border-top:1px solid #555; margin:5px 0;">
                        <div style="font-size:0.75rem; color:#ccc; line-height:1.4; white-space: pre-wrap;" id="hover-demon-desc">...</div>
                    </div>
                    <div id="demon-hp" class="hp-bar"></div>
                </div>

                <div style="display:flex; flex-direction:column; align-items:flex-end;" class="you-area-hover">
                    <div class="lives-wrapper" id="lives-you"></div>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <span id="ui-pact-icon" style="font-size:1.1rem; display:none; text-shadow:0 0 8px var(--accent-cursed); cursor:help;"></span>
                        <div class="hp-label" style="color:var(--accent-green);" id="label-you">YOU</div>
                    </div>
                    <div id="player-hp" class="hp-bar"></div>
                    <div class="my-talent-tooltip">
                        <div style="margin-bottom:4px;">
                            <strong style="color:var(--accent-green)">TALENT: </strong>
                            <span id="hover-talent-name" style="font-weight:bold;">NO TALENT</span><br>
                            <span style="font-size:0.7rem; color:#aaa" id="hover-talent-desc">...</span>
                        </div>
                        <div id="ui-pact-info" style="display:none; border-top:1px solid #444; margin-top:4px; padding-top:4px;">
                            <strong style="color:var(--accent-cursed)">PACT: </strong>
                            <span id="hover-pact-name" style="font-weight:bold; color:var(--accent-cursed);"></span><br>
                            <span style="font-size:0.7rem; color:#ccc" id="hover-pact-desc"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="controls">
                <button id="btn-self" class="action-btn btn-self" onclick="activePlayerAction('self')">
                    <span id="txt-self">SHOOT SELF</span><small id="sub-self">Risk</small>
                </button>
                <button id="btn-enemy" class="action-btn btn-enemy" onclick="activePlayerAction('enemy')">
                    <span id="txt-enemy">SHOOT ENEMY</span><small id="sub-enemy">Damage</small>
                </button>
            </div>
        </div>

        <div id="sicbo-screen" class="modal-overlay">
            <div class="sicbo-content">
                <h1 style="color:var(--accent-gold); margin-bottom:10px;">â˜ ï¸ æ­»äº¡éª°å® â˜ ï¸</h1>
                <p style="color:#aaa; font-size:0.9rem; margin-bottom:30px;">
                    èµŒå¾’ç”¨ä»–çš„å‘½åšæ³¨ã€‚<br>
                    <span style="color:var(--accent-red)">å›´éª° (ä¸‰éª°åŒç‚¹) = ç©å®¶ç›´æ¥å¤±å»ä¸€æ¡å‘½</span>
                </p>
                
                <div class="sicbo-dice-area">
                    <div class="die" id="sb-d1">?</div>
                    <div class="die" id="sb-d2">?</div>
                    <div class="die" id="sb-d3">?</div>
                </div>
                <div id="sicbo-result" style="height:30px; margin:20px 0; font-weight:bold; color:#fff;"></div>

                <div class="sicbo-actions" id="sicbo-btn-group">
                    <button class="menu-btn" onclick="resolveSicBo('small')" style="border-color:var(--accent-blue); color:var(--accent-blue);">
                        <div>SMALL (å°)</div><small>4 - 10 ç‚¹</small>
                    </button>
                    <button class="menu-btn" onclick="resolveSicBo('big')" style="border-color:var(--accent-red); color:var(--accent-red);">
                        <div>BIG (å¤§)</div><small>11 - 17 ç‚¹</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
/* =========================================
   2. constants.js åŸå§‹å†…å®¹
   ========================================= */
const ALL_ITEM_LIST = [
    'magnifier', 'beer', 'saw', 'smoke', 'cuffs', 'inverter', 
    'jammer', 'mirror', 'preload', 'feint', 'safety',
    'hourglass', 'visor', 'delay_shell', 'death_chip', 'adrenaline', 
    'expired_med', 'phone'
];

const ITEM_ICONS = { 
    magnifier:'ğŸ”', beer:'ğŸº', saw:'ğŸªš', smoke:'ğŸš¬', cuffs:'ğŸ”—', inverter:'ğŸ”„', 
    jammer:'ğŸš«', mirror:'ğŸ”®', preload:'â³', feint:'ğŸª¤', safety:'ğŸ§·',
    hourglass:'â³', visor:'ğŸ­', delay_shell:'ğŸ§ª', death_chip:'âš°ï¸', adrenaline:'ğŸ’‰', 
    expired_med: 'ğŸ’Š', phone:'ğŸ“±'
};

const TEXT = {
    zh: {
        pve_btn: "ğŸ’€ å•äººæˆ˜å½¹", pvp_btn: "âš”ï¸ åŒäººå¯¹æˆ˜", restart_btn: "ğŸ  è¿”å›ä¸»èœå•",
        btn_continue: "â–¶ ç»§ç»­æ¸¸æˆ", 
        label_demon: "æ¶é­”", label_p2: "P2", label_you: "ä½ ", label_p1: "P1",
        wait: "ç­‰å¾…...", ready: "ç³»ç»Ÿå°±ç»ª...", reload: "å¼¹è¯è£…å¡«å®Œæ¯•",
        shot_live: "ğŸ’¥ å®å¼¹ï¼{shooter} é€ æˆ {dmg} ç‚¹ä¼¤å®³",
        shot_blank: "ğŸ’¨ ç©ºå¼¹ã€‚{shooter} è¿æ°”ä¸é”™",
        shot_blank_miss: "ğŸ’¨ ç©ºå¼¹ã€‚{shooter} é”™å¤±æœºä¼š",
        safe_bet: "èµŒå¯¹äº†ï¼ä¿ç•™å›åˆ",
        deal_success: "ğŸ˜ˆ å¥‘çº¦è¾¾æˆï¼", deal_fail: "ğŸ’€ å¥‘çº¦å¤±è´¥ï¼",
        item_jammed: "ğŸš« {item} å¤±æ•ˆï¼å—åˆ°å¹²æ‰°ï¼", 
        mirror_steal: "ğŸ”® é­”é•œçªƒå–äº† {item} çš„æ•ˆæœï¼",
        tact_block: "ğŸš« æˆ˜æœ¯å®¶å°é”äº† {item}",
        ammo_fmt: "ã€ {live} å®å¼¹ | {blank} ç©ºå¼¹ ã€‘",
        resurrect: "âœ¨ {name} æ¶ˆè€—ä¸€æ¡å‘½å¤æ´»äº†ï¼",
        btn_self: "å¯¹è‡ªå·±", btn_enemy: "å¯¹æ•Œäºº", 
        sub_self: "é£é™©åšå¼ˆ", sub_enemy: "é€ æˆä¼¤å®³",
        twist_on: "â˜£ æ‰­æ›²æ¨¡å¼ (å¼€)", twist_off: "â˜£ æ‰­æ›²æ¨¡å¼ (å…³)",
        i_magnifier: "æ”¾å¤§é•œ", d_magnifier: "ç¡®è®¤ä¸‹ä¸€å‘å­å¼¹ã€‚", 
        i_beer: "å•¤é…’", d_beer: "é€€å»å½“å‰å­å¼¹ã€‚",
        i_saw: "é”¯å­", d_saw: "ä¸‹ä¸€å‘ä¼¤å®³ç¿»å€ã€‚", 
        i_smoke: "é¦™çƒŸ", d_smoke: "å›å¤ 1 ç‚¹ç”Ÿå‘½å€¼ã€‚",
        i_cuffs: "æ‰‹é“", d_cuffs: "è·³è¿‡å¯¹æ‰‹å›åˆã€‚", 
        i_inverter: "é€†è½¬å™¨", d_inverter: "è½¬æ¢å½“å‰å­å¼¹è™šå®ã€‚",
        i_jammer: "å¹²æ‰°å™¨", d_jammer: "åºŸæ‰å¯¹æ‰‹é“å…·ã€‚", 
        i_mirror: "é­”é•œ", d_mirror: "çªƒå–å¢ç›Šã€‚",
        i_preload: "é¢„è£…å¼¹", d_preload: "åº•éƒ¨å¡å…¥ä¸€å‘å®å¼¹ã€‚", 
        i_feint: "å‡åŠ¨ä½œ", d_feint: "ä¸‹ä¸€ä¸ªé“å…·æ— æ•ˆä½†å¯è§ã€‚",
        i_safety: "ä¿é™©æ “", d_safety: "æŠµæŒ¡ä¸€æ¬¡è‡´æ­»è‡ªä¼¤ã€‚",
        i_hourglass: "ç¼“åˆ‘æ²™æ¼", d_hourglass: "å½“å‰å­å¼¹ç§»è‡³æœ€åº•éƒ¨ã€‚",
        i_visor: "å‡è§†é•œ", d_visor: "(PvP) å¯¹æ‰‹çœ‹åˆ°çš„ä¸‹ä¸€æ¬¡æç¤ºåè½¬ã€‚",
        i_delay_shell: "åæ•ˆå¼¹", d_delay_shell: "å®å¼¹ä¼¤å®³å»¶è¿Ÿ 2 å›åˆç”Ÿæ•ˆã€‚",
        i_death_chip: "ä¸´ç»ˆç­¹ç ", d_death_chip: "è‹¥æœ¬è½®æ­»äº¡ï¼Œå¯¹æ•Œäººé€ æˆ 2 ç‚¹ä¼¤å®³ã€‚",
        i_adrenaline: "è‚¾ä¸Šè…ºç´ ", d_adrenaline: "å†æ¬¡è¡ŒåŠ¨ï¼Œä½†ä¸‹å›åˆæ‰£ 1 HPã€‚",
        i_expired_med: "è¿‡æœŸè¯", d_expired_med: "50% å›1è¡€,50% æ‰£1è¡€ã€‚",
        i_phone: "ç¥ç§˜æ‰‹æœº", d_phone: "æŸ¥çœ‹æœªæ¥éšæœºä¸€å‘å­å¼¹ã€‚",
        e_calm: "æ­»å¯‚", ed_calm: "ä¸€åˆ‡éƒ½å¾ˆå¹³é™... æš‚æ—¶ã€‚",
        e_mist: "æµ“é›¾", ed_mist: "çœ‹ä¸æ¸…å¼¹ä»“æ•°é‡ (è®°ç‰Œå™¨å¤±æ•ˆ)ã€‚",
        e_blood_moon: "è¡€æœˆ", ed_blood_moon: "æ— æ³•å›å¤ç”Ÿå‘½å€¼ (æ²»ç–—å¤±æ•ˆ)ã€‚",
        e_rust: "é”ˆèš€", ed_rust: "é“å…·è€åŒ–,30% æ¦‚ç‡ä½¿ç”¨å¤±æ•ˆã€‚",
        e_carnival: "ç‹‚æ¬¢", ed_carnival: "é“å…·æ‰è½é‡ç¿»å€ï¼",
        e_static: "é™ç”µ", ed_static: "å¼€ç«æœ‰ 25% æ¦‚ç‡è§¦å‘è¿å°„ (ä¸æ¶ˆè€—å›åˆ)ã€‚",
        e_drought: "å¹²æ—±", ed_drought: "èµ„æºåŒ®ä¹ï¼Œæ¯è½®é“å…· -1ã€‚",
        rust_fail: "ğŸ‚ é“å…·å› ä¸ºé”ˆèš€ç¢æ‰äº†ï¼",
        static_trigger: "âš¡ é™ç”µååº”ï¼ç«‹å³å†æ¬¡è¡ŒåŠ¨ï¼",
        med_heal: "ğŸ’Š è¯æ•ˆæƒŠäººï¼æ¢å¤ 1 ç‚¹ç”Ÿå‘½ã€‚",
        med_hurt: "ğŸ¤¢ è¿‡æœŸäº†... å—åˆ° 1 ç‚¹æ¯’ç´ ä¼¤å®³ï¼",
        no_heal_blood: "ğŸ©¸ è¡€æœˆä¹‹ä¸‹æ— æ³•æ²»ç–—ï¼",
        mech_dud: "ğŸ’¨ å“‘å¼¹ï¼å­å¼¹å—æ½®äº†ï¼Œæ— äººå—ä¼¤ã€‚",
        mech_jam: "ğŸ”¥ å¡å£³ï¼æªç®¡è¿‡çƒ­ï¼Œå¼ºåˆ¶ç»“æŸå›åˆã€‚",
        mech_mutual: "âš–ï¸ åŒå½’äºå°½ï¼ä¸´ç»ˆç­¹ç è§¦å‘ï¼",
        win_draw: "å¹³å±€", win_draw_desc: "æ²¡æœ‰äººæ´»ç€ç¦»å¼€ã€‚",
        win_died: "ä½ æ­»äº†", win_vic: "èƒœåˆ©", 
        win_kill: "è¢« {name} å‡»æ€", win_reward: "å‡»è´¥ {name}ï¼Œé€‰æ‹©å¥–åŠ±ï¼š",
        b_butcher: "å± å¤«", p_butcher: "è¢«åŠ¨ï¼šä¼¤å®³æŠ—æ€§ & æš´åŠ›",
        desc_butcher: "ã€æš´è™ã€‘\n1. è„‚è‚ªå±‚ï¼šå•æ¬¡å—åˆ°çš„ä¼¤å®³ä¸Šé™é”å®šä¸º 2 ç‚¹ã€‚\n2. è›®åŠ›ï¼šå®å¼¹ä¼¤å®³ +1 (æš´èµ°å +2)ã€‚",
        b_gambler: "èµŒå¾’", p_gambler: "è¢«åŠ¨ï¼šå¼€å±€çªƒå–é“å…·",
        desc_gambler: "ã€å‡ºåƒã€‘\n1. é¡ºæ‰‹ç‰µç¾Š:æ¯å›åˆå¼€å§‹æ—¶,60% æ¦‚ç‡å·å–ä½ ä¸€ä¸ªé“å…·ã€‚\n2. å®ƒæ˜¯åº„å®¶ï¼Œå®ƒè¯´äº†ç®—ã€‚",
        b_doctor: "ç˜ŸåŒ»", p_doctor: "è¢«åŠ¨ï¼šç—…æ¯’æ„ŸæŸ“ & è‡ªæ„ˆ",
        desc_doctor: "ã€ç—…æ¯’ã€‘\n1. æ„ŸæŸ“:å®å¼¹é™„å¸¦å‰§æ¯’,2å›åˆåé€ æˆé¢å¤– 1 ç‚¹ä¼¤å®³ã€‚\n2. è‡ªæ„ˆï¼šå›åˆå¼€å§‹æ—¶æ¦‚ç‡å›å¤ç”Ÿå‘½å€¼ã€‚",
        b_tactician: "æˆ˜æœ¯å®¶", p_tactician: "è¢«åŠ¨ï¼šå°é” & å¹²æ‰°",
        desc_tactician: "ã€è°æˆ˜ã€‘\n1. å¹²æ‰°ï¼šä½ ä½¿ç”¨çš„æ”¾å¤§é•œæœ‰ 50% æ¦‚ç‡æ˜¾ç¤ºå‡æƒ…æŠ¥ã€‚\n2. å°é”ï¼šæ¯å›åˆä½ ä¼šæœ‰ä¸€ä¸ªé“å…·è¢«å…¶è¢«åŠ¨å°é”ã€‚",
        b_player2: "ç©å®¶P2", p_player2: "å…¬å¹³å¯¹å†³",
        desc_player2: "å¦ä¸€ä¸ªä¸å¹¸çš„çµé­‚ã€‚\næ²¡æœ‰ç‰¹æ®Šèƒ½åŠ›,å®Œå…¨å…¬å¹³çš„å¯¹å†³ã€‚",
        enrage_title: "âš  é˜¶æ®µäºŒï¼šæš´èµ°", 
        enrage_butcher: "ä¼¤å®³ +2 | è·å¾—é”¯å­",
        enrage_gambler: "ç›—å–é“å…· | å¼¹è¯é”™ä¹±", 
        enrage_doctor: "ç´§æ€¥æ²»ç–— +2 HP", 
        enrage_tactician: "å°é”è¡ŒåŠ¨ | è·å¾—æ‰‹é“",
        e_normal: "å¹³é™", ed_normal: "æ— ç‰¹æ®Šè§„åˆ™", 
        e_overheat: "æªç®¡è¿‡çƒ­", ed_overheat: "è¿ç»­å®å¼¹ä¼¤å®³å åŠ ",
        e_blood: "è¡€å€ºè¡€å¿", ed_blood: "è‡ªä¼¤åŠ å€ï¼Œæ— ä¿ç•™å›åˆ", 
        e_shuffle: "ç©ºé—´é”™ä¹±", ed_shuffle: "è£…å¡«åå¼¹èˆ±æ‰“ä¹±ä¸¤æ¬¡",
        e_vision: "å…¨æ¯ç„å‡†", ed_vision: "25% æ¦‚ç‡æ˜¾ç¤ºå­å¼¹è™šå®",
        e_fog: "è¿·é›¾å›åˆ", ed_fog: "å†å²å¤±æ•ˆï¼Œåªæ˜¾ç¤ºæ€»å¼¹æ•°", 
        e_fair: "å…¬å¹³å®¡åˆ¤", ed_fair: "æ— æ³•è¿ç»­è¡ŒåŠ¨",
        e_volatile: "ä¸ç¨³å®šå¼¹è¯", ed_volatile: "ç©ºå¼¹ 30% æ¦‚ç‡å˜å®å¼¹", 
        e_sacrifice: "è¡€ç¥­", ed_sacrifice: "ä½¿ç”¨é“å…·æ‰£ 1 HP",
        buff_heal: "æ€¥æ•‘åŒ…", bd_heal: "HP å…¨å›æ»¡", 
        buff_hp: "é˜²å¼¹è¡£", bd_hp: "HP ä¸Šé™ +1",
        buff_box: "å†›ç«ç®±", bd_box: "éšæœºé“å…· x4", 
        buff_tech: "é»‘ç§‘æŠ€", bd_tech: "å¹²æ‰°å™¨ + é­”é•œ",
        talent_eye: "é¹°çœ¼", td_eye: "é¦–å‘å­å¼¹ 30% æ˜ç‰Œ", 
        talent_pack: "å›¤ç§¯è€…", td_pack: "åˆå§‹é“å…· +1",
        talent_luck: "èµŒåœ£", td_luck: "ç©ºå¼¹å¿…ä¿ç•™å›åˆ",
        talent_pain: "ç—›è§‰é€‚åº”", td_pain: "å¯¹è‡ªå·±å®å¼¹ä¼¤å®³-1", 
        talent_alarm: "è™šæƒŠä¸€åœº", td_alarm: "è‡ªä¼¤ç©ºå¼¹è“„åŠ›ä¸‹ä¸€æ¬¡",
        talent_poker: "æ‰‘å…‹è„¸", td_poker: "å¯¹æ‰‹æ— æ³•çœ‹å†å²è®°å½•", 
        talent_mis: "è¯¯å¯¼", td_mis: "æ”¾å¤§é•œ50%ç»™å‡æƒ…æŠ¥",
        talent_ban: "ç¦å¿Œ", td_ban: "éšæœºç¦ç”¨2ç§é“å…·", 
        talent_quick: "å¿«æªæ‰‹", td_quick: "æœ¬è½®ä¸ç”¨é“å…·åˆ™å¢ä¼¤",
        talent_boom: "è‡ªçˆ†", td_boom: "è‡ªä¼¤ç©ºå¼¹å¯¹æ•Œé€ æˆä¼¤å®³",
        pact_flesh: "è¡€è‚‰ç­¹ç ", pd_flesh: "æœ€å¤§HP-2ã€‚å¯¹è‡ªå·±ç©ºå¼¹è·æŠ¤ç›¾ã€‚",
        pact_half: "åŠæ¡å‘½èµŒå¾’", pd_half: "HPä¸Šé™é”å®š3ã€‚å®å¼¹ä¼¤å®³+1ã€‚",
        pact_eerie: "è¯¡å¼‚å¼¹ä»“", pd_eerie: "æ¯è½®å¼€å§‹éšæœºåè½¬ä¸€å‘å­å¼¹ã€‚",
        pact_echo: "å›å£°å­å¼¹", pd_echo: "å®å¼¹ 25% æ¦‚ç‡è¿”å›å¼¹ä»“ã€‚",
        pact_eye: "æ¬ºè¯ˆä¹‹çœ¼", pd_eye: "é“å…· 50% å‡å¤±æ•ˆï¼ŒæˆåŠŸåˆ™ç¿»å€ã€‚",
        pact_acute: "æ€¥æ€§æ­»äº¡", pd_acute: "è‹¥å›åˆæœªé€ æˆä¼¤å®³ æ‰£1ç”Ÿå‘½ã€‚",
        pact_strict: "ä¸å®¹å¤±è¯¯", pd_strict: "å¯¹æ•Œå¼€ç©ºå¼¹è·³è¿‡ä¸‹å›åˆã€‚",
        pact_greed: "è„†å¼±çš„è´ªå©ª", pd_greed: "æœ€å¤§HP-1ã€‚ä»»æ„ç©ºå¼¹å¾—é“å…·ã€‚",
        pact_power: "æ··ä¹±åŠ›é‡", pd_power: "å®å¼¹ä¼¤å®³+1ã€‚ä»»æ„ç©ºå¼¹æ´—ç‰Œã€‚",
        eval_perfect: "â€œå¤–ç§‘æ‰‹æœ¯èˆ¬çš„ç²¾å‡†ã€‚â€", eval_clutch: "â€œæ­»ç¥åˆšæ‰å¯¹ä½ çœ¨çœ¼äº†ã€‚â€",
        eval_lucky: "â€œçº¯ç²¹çš„ç‹—å±è¿ã€‚â€", eval_brutal: "â€œä½ æ˜¯ä¸ªç–¯å­ã€‚â€",
        eval_sad: "â€œå¯æ€œçš„çµé­‚ã€‚â€", eval_greedy: "â€œè´ªå©ªæ€æ­»äº†çŒ«ï¼Œå’Œä½ ã€‚â€",
        s_resume: "â–¶ ç»§ç»­æ¸¸æˆ", s_menu: "ğŸ  ä¸»èœå•", s_giveup: "ğŸ³ï¸ æ”¾å¼ƒ", s_sound: "éŸ³æ•ˆ",
        toast_gain: "è·å¾—é“å…·", toast_gain_p2: "å¯¹æ‰‹è·å¾—", 
        ach_1: "ç¬¬ä¸€æ»´è¡€", ad_1:"åœ¨æ¸¸æˆä¸­å­˜æ´»ã€‚", ach_2: "è€çƒŸæª", ad_2:"ä½¿ç”¨é¦™çƒŸã€‚",
        ach_3: "èµŒå‘½ä¹‹å¾’", ad_3:"å¯¹è‡ªå·±å¼€ç©ºæªã€‚", ach_4: "è¿èƒœ", ad_4:"???",
        ach_5: "ä¾¦æ¢", ad_5:"ä½¿ç”¨3æ¬¡æ”¾å¤§é•œã€‚", ach_6: "ç”Ÿæ­»ä¸€çº¿", ad_6:"ä»¥1ç‚¹ç”Ÿå‘½å€¼è·èƒœã€‚",
        ach_7: "æ‰­æ›²è¡Œè€…", ad_7:"åœ¨æ‰­æ›²æ¨¡å¼è·èƒœã€‚", ach_8: "å± å¤«çŒæ‰‹", ad_8:"å‡»è´¥å± å¤«ã€‚",
        ach_9: "æˆ˜æœ¯å¤§å¸ˆ", ad_9:"å‡»è´¥æˆ˜æœ¯å®¶æˆ–ä½¿ç”¨å¹²æ‰°å™¨ã€‚", ach_10: "æ¯«å‘æ— ä¼¤", ad_10:"æ»¡è¡€è·èƒœã€‚",
        ach_11: "åº¸åŒ»", ad_11:"å‡»è´¥ç˜ŸåŒ»ã€‚", ach_12: "åº„å®¶é€šåƒ", ad_12:"å‡»è´¥èµŒå¾’ã€‚",
        ach_13: "é…’é¬¼", ad_13:"å•å±€å–æ‰3ç“¶å•¤é…’ã€‚", ach_14: "???", ad_14:"???",
        ach_15: "ä»¥å½¼ä¹‹é“", ad_15:"ä½¿ç”¨é­”é•œã€‚", ach_16: "æ­»é‡Œé€ƒç”Ÿ", ad_16:"ä¿é™©æ “æŒ¡ä¸‹ä¸€æ¬¡æ­»äº¡ã€‚",
        ach_17: "ä½œå¼Šè€…", ad_17:"ä½¿ç”¨é¢„è£…å¼¹ã€‚", ach_18: "å¿ƒç†æˆ˜", ad_18:"ä½¿ç”¨å‡åŠ¨ä½œã€‚",
        ach_19: "å¥‘çº¦è€…", ad_19:"åœ¨æ‹¥æœ‰å¥‘çº¦æ—¶è·èƒœã€‚", ach_20: "ç›²äººæ‘¸è±¡", ad_20:"åœ¨è¿·é›¾äº‹ä»¶ä¸­è·èƒœã€‚",
        ach_21: "è‡ªä½œè‡ªå—", ad_21:"å¯¹è‡ªå·±å¼€äº†ä¸€å‘å®å¼¹ã€‚", ach_22: "æš´åŠ›ç¾å­¦", ad_22:"ä½¿ç”¨é”¯å­ã€‚",
        ach_23: "ç¦é”¢", ad_23:"ä½¿ç”¨æ‰‹é“ã€‚", ach_24: "é¢ å€’é»‘ç™½", ad_24:"ä½¿ç”¨é€†è½¬å™¨ã€‚",
        ach_25: "ä¿¡å·å±è”½", ad_25:"ä½¿ç”¨å¹²æ‰°å™¨ã€‚", ach_26: "å›¤ç§¯ç™–", ad_26:"æŒæœ‰è¶…è¿‡6ä¸ªé“å…·ã€‚",
        ach_27: "è¿‡åº¦æ€ä¼¤", ad_27:"å•å‘é€ æˆ3ç‚¹ä»¥ä¸Šä¼¤å®³å¹¶å‡»æ€ã€‚", ach_28: "ç–¯å­", ad_28:"åœ¨1ç‚¹ç”Ÿå‘½å€¼æ—¶å¯¹è‡ªå·±å¼€æªã€‚",
        ach_29: "è¡€ç¥­", ad_29:"åœ¨è¡€ç¥­äº‹ä»¶ä¸­è·èƒœã€‚", ach_30: "èµ„æ·±ç©å®¶", ad_30:"åˆ°è¾¾ç¬¬3å…³ã€‚",
        subtitle_fix: "ä¿„ç½—æ–¯è½®ç›˜æ›´æ–°", title_talent: "é€‰æ‹©å¤©èµ‹", title_pact: "é»‘æš—å¥‘çº¦", 
        pact_desc: "é«˜é£é™©ï¼Œé«˜å›æŠ¥ã€‚", btn_nodeal: "æ‹’ç»å¥‘çº¦", setting_paused: "æš‚åœ",
        boss_unknown: "æœªçŸ¥",
        rr_trigger: "ğŸ² ä¿„ç½—æ–¯è½®ç›˜æ¨¡å¼ï¼", rr_desc: "1 å®å¼¹ 5 ç©ºå¼¹ã€‚è½®æµå¯¹è‡ªå·±å¼€æªã€‚ç”Ÿæ­»æœ‰å‘½ã€‚",
        btn_pull: "æ‰£åŠ¨æ‰³æœº"
    },
    en: {
        pve_btn: "ğŸ’€ Campaign", pvp_btn: "âš”ï¸ Versus", restart_btn: "ğŸ  MAIN MENU",
        btn_continue: "â–¶ CONTINUE", label_demon: "DEMON", label_p2: "P2", label_you: "YOU", label_p1: "P1",
        wait: "Waiting...", ready: "Ready...", reload: "Reloaded",
        shot_live: "ğŸ’¥ LIVE! {shooter} deals {dmg} dmg", shot_blank: "ğŸ’¨ BLANK. {shooter} safe.",
        shot_blank_miss: "ğŸ’¨ BLANK. Missed.", safe_bet: "Safe!", deal_success: "ğŸ˜ˆ DEAL MET!", deal_fail: "ğŸ’€ DEAL FAILED!",
        item_jammed: "ğŸš« {item} JAMMED!", mirror_steal: "ğŸ”® Mirror stole {item} effect!", tact_block: "ğŸš« Tactician blocked {item}!",
        ammo_fmt: "[ {live} LIVE | {blank} BLANK ]", resurrect: "âœ¨ {name} consumed a life to resurrect!",
        btn_self: "SHOOT SELF", btn_enemy: "SHOOT ENEMY", sub_self: "Gamble", sub_enemy: "Deal Dmg",
        twist_on: "â˜£ TWISTED (ON)", twist_off: "â˜£ TWISTED (OFF)",
        i_magnifier: "Magnifier", d_magnifier: "Check round.", i_beer: "Beer", d_beer: "Eject round.",
        i_saw: "Hand Saw", d_saw: "2x Damage.", i_smoke: "Cigarettes", d_smoke: "Heal 1 HP.",
        i_cuffs: "Handcuffs", d_cuffs: "Skip turn.", i_inverter: "Inverter", d_inverter: "Invert round.",
        i_jammer: "Jammer", d_jammer: "Block item.", i_mirror: "Mirror", d_mirror: "Steal buff.",
        i_preload: "Preload", d_preload: "Insert Live round at bottom.", i_feint: "Feint", d_feint: "Next item is fake.",
        i_safety: "Safety", d_safety: "Prevent suicide death once.",
        i_hourglass: "Hourglass", d_hourglass: "Move round.", i_visor: "Deceptive Visor", d_visor: "Fake clues.",
        i_delay_shell: "Delayed Round", d_delay_shell: "Late Dmg.", i_death_chip: "Death Chip", d_death_chip: "Mutual destruction.",
        i_adrenaline: "Adrenaline", d_adrenaline: "Act again, hurt later.", 
        i_expired_med: "Expired Meds", d_expired_med: "50% Heal 1 HP, 50% Take 1 Dmg.",
        i_phone: "Phone", d_phone: "Check future.",
        e_calm: "Calm", ed_calm: "Standard rules apply.", e_mist: "The Mist", ed_mist: "Ammo counts hidden.",
        e_blood_moon: "Blood Moon", ed_blood_moon: "Healing effects disabled.",
        e_rust: "Rust", ed_rust: "Items have 30% failure chance.", e_carnival: "Carnival", ed_carnival: "Double item loot.",
        e_static: "Static", ed_static: "25% chance to shoot again instantly.", e_drought: "Drought", ed_drought: "Loot -1 per round.",
        rust_fail: "ğŸ‚ Item crumbled due to Rust!", static_trigger: "âš¡ Static Discharge! Act again!",
        med_heal: "ğŸ’Š It worked! +1 HP.", med_hurt: "ğŸ¤¢ Expired... -1 HP!",
        no_heal_blood: "ğŸ©¸ Blood Moon prevents healing!",
        mech_dud: "ğŸ’¨ DUD! Wet powder.", mech_jam: "ğŸ”¥ JAMMED! Overheated.", mech_mutual: "âš–ï¸ MUTUAL DESTRUCTION!",
        win_draw: "DRAW", win_draw_desc: "No survivors.",
        b_butcher: "Butcher", p_butcher: "Passive: Resist & Force",
        desc_butcher: "[BRUTAL]\n1. Thick Skin: Max damage taken per shot is capped at 2.\n2. Force: Live round DMG +1 (Enrage +2).",
        b_gambler: "Gambler", p_gambler: "Passive: Steal Items",
        desc_gambler: "[RIGGED]\n1. Pickpocket: 60% chance to steal 1 item at start of turn.\n2. The House always wins.",
        b_doctor: "Doctor", p_doctor: "Passive: Poison & Heal",
        desc_doctor: "[VIRUS]\n1. Infection: Live shots apply poison (1 DMG after 2 turns).\n2. Self-Care: Chance to heal at start of turn.",
        b_tactician: "Tactician", p_tactician: "Passive: Block & Jam",
        desc_tactician: "[INTEL]\n1. Jamming: Your Magnifier has 50% chance to show FAKE info.\n2. Blockade: One of your items is blocked each turn.",
        b_player2: "P2", p_player2: "Fair Play", desc_player2: "Another poor soul.\nFair fight. No special abilities.",
        enrage_title: "âš  ENRAGE", enrage_butcher: "DMG+2 | Saw", enrage_gambler: "Steal | Shuffle",
        enrage_doctor: "Heal +2 HP", enrage_tactician: "Lock | Cuffs",
        e_normal: "Calm", ed_normal: "No special rules", e_overheat: "Overheat", ed_overheat: "Live shots increase DMG",
        e_blood: "Blood Debt", ed_blood: "Self-shot: 2x DMG, No Turn Retention", e_shuffle: "Shuffle", ed_shuffle: "Chamber shuffled twice",
        e_vision: "Holo-Sight", ed_vision: "25% chance to reveal round",
        e_fog: "Fog", ed_fog: "History & Colors hidden", e_fair: "Fair Play", ed_fair: "No consecutive turns",
        e_volatile: "Volatile Ammo", ed_volatile: "30% chance Blank becomes Live", e_sacrifice: "Sacrifice", ed_sacrifice: "Use Item costs 1 HP",
        buff_heal: "Medkit", bd_heal: "Heal to Full", buff_hp: "Armor", bd_hp: "Max HP +1",
        buff_box: "Ammo Box", bd_box: "4 Items", buff_tech: "High-Tech", bd_tech: "Jammer + Mirror",
        talent_eye: "Eagle Eye", td_eye: "30% Reveal 1st Round", talent_pack: "Hoarder", td_pack: "Start +1 Item",
        talent_luck: "Saint", td_luck: "Guaranteed Turn Keep",
        talent_pain: "Adaptation", td_pain: "Self Live Dmg -1", talent_alarm: "False Alarm", td_alarm: "Self Blank boosts next Live",
        talent_poker: "Poker Face", td_poker: "Hide history", talent_mis: "Mislead", td_mis: "50% Fake Magnifier",
        talent_ban: "Embargo", td_ban: "Randomly ban 2 items", talent_quick: "Quick Draw", td_quick: "No item use = Dmg +1",
        talent_boom: "Self-Destruct", td_boom: "Self Blank deals Dmg to enemy",
        pact_flesh: "Flesh Chips", pd_flesh: "Max HP -2. Shield.", pact_half: "Half-Life", pd_half: "HP capped at 3.",
        pact_eerie: "Eerie Mag", pd_eerie: "Flip 1 bullet.", pact_echo: "Echo Bullets", pd_echo: "Return Live.",
        pact_eye: "Deceptive Eye", pd_eye: "Items 50% fake.", pact_acute: "Acute Death", pd_acute: "No Dmg = -1 HP.",
        pact_strict: "No Mistakes", pd_strict: "Miss = Skip.", pact_greed: "Greed", pd_greed: "-1 Max HP. Item on Blank.",
        pact_power: "Chaos Power", pd_power: "+1 Dmg. Shuffle on Blank.",
        eval_perfect: "â€œSurgical precision.â€", eval_clutch: "â€œDeath just blinked.â€",
        eval_lucky: "â€œPure dumb luck.â€", eval_brutal: "â€œYou are a maniac.â€",
        eval_sad: "â€œPoor soul.â€", eval_greedy: "â€œGreed killed you.â€",
        win_died: "YOU DIED", win_vic: "VICTORY", win_kill: "Killed by {name}", win_reward: "Defeated {name}. Reward:",
        s_resume: "â–¶ RESUME", s_menu: "ğŸ  MAIN MENU", s_giveup: "ğŸ³ï¸ GIVE UP", s_sound: "Sound Effects",
        toast_gain: "ITEM ACQUIRED", toast_gain_p2: "ENEMY GAINED",
        ach_1: "First Blood", ad_1:"Survive the game.", ach_2: "Smoker", ad_2:"Use Cigarettes.",
        ach_3: "Risk Taker", ad_3:"Shoot self with blank.", ach_4: "Streak", ad_4:"???",
        ach_5: "Detective", ad_5:"Use Magnifier 3 times.", ach_6: "Clutch", ad_6:"Win with 1 HP.",
        ach_7: "Twisted", ad_7:"Win Twisted Mode.", ach_8: "Butcher Bane", ad_8:"Defeat Butcher.",
        ach_9: "Strategist", ad_9:"Defeat Tactician or Jam.", ach_10: "Flawless", ad_10:"Win with full HP.",
        ach_11: "Anti-Vax", ad_11:"Defeat Doctor.", ach_12: "House Wins", ad_12:"Defeat Gambler.",
        ach_13: "Alcoholic", ad_13:"Drink 3 Beers.", ach_14: "???", ad_14:"???",
        ach_15: "Reflection", ad_15:"Use Mirror.", ach_16: "Safe", ad_16:"Safety prevented death.",
        ach_17: "Cheater", ad_17:"Use Preload.", ach_18: "Mind Games", ad_18:"Use Feint.",
        ach_19: "Deal Maker", ad_19:"Win with a Pact.", ach_20: "Blind", ad_20:"Win in Fog.",
        ach_21: "Oops", ad_21:"Shot self with Live.", ach_22: "Brutal", ad_22:"Use Saw.",
        ach_23: "Lockdown", ad_23:"Use Cuffs.", ach_24: "Inverted", ad_24:"Use Inverter.",
        ach_25: "Jammed", ad_25:"Use Jammer.", ach_26: "Hoarder", ad_26:"Hold 6+ items.",
        ach_27: "Overkill", ad_27:"Deal 3+ DMG and kill.", ach_28: "Madman", ad_28:"Shoot self at 1 HP.",
        ach_29: "Sacrifice", ad_29:"Win Sacrifice event.", ach_30: "Veteran", ad_30:"Reach Level 3.",
        subtitle_fix: "Roulette Update", title_talent: "CHOOSE TALENT", title_pact: "DARK PACT", 
        pact_desc: "High Risk, High Reward.", btn_nodeal: "NO DEAL", setting_paused: "PAUSED",
        boss_unknown: "UNKNOWN", rr_trigger: "ğŸ² RUSSIAN ROULETTE!",
        rr_desc: "1 Live, 5 Blank. Pull trigger on self. Last one standing wins.", btn_pull: "PULL TRIGGER"
    }
};

const BOSS_TAUNTS = {
    butcher: { miss: ["Too weak.", "Is that it?", "Pathetic."], hit: ["I bleed...", "Again!", "Harder."], win: ["Next time.", "You got lucky."], taunt: ["I smell fear.", "Shoot. Now."] },
    gambler: { miss: ["Bad luck?", "House wins.", "Did you count?"], hit: ["A lucky guess.", "Hey, watch the suit!"], win: ["I want a rematch.", "You cheated."], taunt: ["Feeling lucky?", "Odds are against you."] },
    doctor: { miss: ["Missed diagnosis.", "Steady your hand.", "Pulse rising."], hit: ["Critical condition.", "I need a medic."], win: ["Flatline.", "Procedure failed."], taunt: ["This will hurt.", "Open wide."] },
    tactician: { miss: ["Calculated.", "Predicted.", "Waste of ammo."], hit: ["Error in judgment.", "Adjusting..."], win: ["Impossible.", "Data corrupted."], taunt: ["Checkmate soon.", "Your move."] },
    player2: { miss: ["LOL", ":)"], hit: ["Ouch", ":("], win: ["GG", "EZ"], taunt: ["..."] }
};

const EVENTS = [
    { id: 'calm', weight: 40 }, { id: 'mist', weight: 10 }, { id: 'blood_moon', weight: 10 },
    { id: 'rust', weight: 10 }, { id: 'carnival', weight: 10 }, { id: 'static', weight: 10 },
    { id: 'drought', weight: 10 }
];

const DEMON_ARCHETYPES = [
    { id: 'butcher', style: 'aggressive', loadout: { saw: 2, beer: 1, mirror: 1 }, phase2: false },
    { id: 'gambler', style: 'chaotic', loadout: { inverter: 2, magnifier: 1, jammer: 1 }, phase2: false },
    { id: 'doctor', style: 'defensive', loadout: { smoke: 2, cuffs: 1, mirror: 1 }, phase2: false },
    { id: 'tactician', style: 'standard', loadout: { jammer: 2, mirror: 1 }, phase2: false }
];

const TALENTS = [
    { id: 'eye', key: 'talent_eye', desc: 'td_eye', icon: 'ğŸ‘ï¸' },
    { id: 'pack', key: 'talent_pack', desc: 'td_pack', icon: 'ğŸ’' },
    { id: 'luck', key: 'talent_luck', desc: 'td_luck', icon: 'ğŸ²' },
    { id: 'pain', key: 'talent_pain', desc: 'td_pain', icon: 'ğŸ”¥' },
    { id: 'alarm', key: 'talent_alarm', desc: 'td_alarm', icon: 'ğŸ­' },
    { id: 'poker', key: 'talent_poker', desc: 'td_poker', icon: 'ğŸƒ' },
    { id: 'mis', key: 'talent_mis', desc: 'td_mis', icon: 'ğŸ‘ï¸â€ğŸ—¨ï¸' },
    { id: 'ban', key: 'talent_ban', desc: 'td_ban', icon: 'ğŸš«' },
    { id: 'quick', key: 'talent_quick', desc: 'td_quick', icon: 'â›“ï¸' },
    { id: 'boom', key: 'talent_boom', desc: 'td_boom', icon: 'ğŸ’¥' }
];

const PACTS = [
    { id: 'greed', key: 'pact_greed', desc: 'pd_greed', icon: 'ğŸ’°' },
    { id: 'power', key: 'pact_power', desc: 'pd_power', icon: 'ğŸŒ©ï¸' },
    { id: 'flesh', key: 'pact_flesh', desc: 'pd_flesh', icon: 'ğŸ©¸' },
    { id: 'half', key: 'pact_half', desc: 'pd_half', icon: 'â˜ ï¸' },
    { id: 'eerie', key: 'pact_eerie', desc: 'pd_eerie', icon: 'ğŸ”«' },
    { id: 'echo', key: 'pact_echo', desc: 'pd_echo', icon: 'ğŸ”„' },
    { id: 'eye', key: 'pact_eye', desc: 'pd_eye', icon: 'ğŸ‘ï¸' },
    { id: 'acute', key: 'pact_acute', desc: 'pd_acute', icon: 'âŒ›' },
    { id: 'strict', key: 'pact_strict', desc: 'pd_strict', icon: 'âš–ï¸' }
];

const buffPool = [
    { id: 'heal', key: 'buff_heal', descKey: 'bd_heal' },
    { id: 'hp_up', key: 'buff_hp', descKey: 'bd_hp' },
    { id: 'supplies', key: 'buff_box', descKey: 'bd_box' },
    { id: 'tech', key: 'buff_tech', descKey: 'bd_tech' }
];

const ACHIEVEMENTS = [];
for(let i=1; i<=30; i++) ACHIEVEMENTS.push({ id: i, key: `ach_${i}` });

/* =========================================
   3. engine.js åŸå§‹å†…å®¹
   ========================================= */
let curLang = 'zh', gameMode = 'pve', level = 1, isTwisted = false; 
let starterItemsBuffer = []; 
let magazine = [], chamberKnowledge = [], historyLog = []; 
let hp = { 1: 4, 2: 3 }, maxHp = { 1: 4, 2: 3 }, lives = { 1: 2, 2: 2 }; 
let currentItems = { 1: {}, 2: {} }; 
let statusEffects = { 1: { jammed: false, mirror: false, shield: 0 }, 2: { jammed: false, mirror: false, shield: 0 } }; 
let currentTurn = 1, currentBoss = null, currentEvent = null, gameLock = false; 
let selectedTalent = null, selectedPact = null, isRussianRoulette = false; 
let mirrorSelectionMode = false; 

let damageMultiplier = 1; 
let handCuffedTarget = 0; 
let globalTimer = null;   
let soundEnabled = true, itemsUsedThisTurn = 0, damageDealtThisTurn = false; 
let ITEM_LIST = [...ALL_ITEM_LIST]; 
let bannedItems = []; 
let falseAlarmBuff = 0; 
let feintActive = false; 
let safetyActive = false; 
let beerCount = 0; 
let magnifierCount = 0; 
let delayedDamageQueue = { 1: [], 2: [] }; 
let deathChipActive = { 1: false, 2: false }; 
let visorActive = false; 
let adrenalineDebt = { 1: false, 2: false }; 
let nextShotIsDelayed = false; 
let tacticianTrapActive = false; 
let isDevilDealActive = false; 
let unlockedAchieves = JSON.parse(localStorage.getItem('br_achievements')) || []; 
let consecutiveLiveShots = 0; 

const MAX_ITEMS = 8;
const ITEM_WEIGHTS = {
    'magnifier': 4, 'beer': 4, 'smoke': 4, 'expired_med': 4, 
    'inverter': 3, 'safety': 3, 'hourglass': 3, 'phone': 3, 'feint': 3,
    'saw': 2, 'jammer': 2, 'preload': 2, 'visor': 2, 'delay_shell': 2,
    'cuffs': 1, 'mirror': 1, 'adrenaline': 1, 'death_chip': 1
};

function getLiveProbability() {
    if (magazine.length === 0) return 0;
    let liveCount = magazine.filter(b => b === 1).length;
    let nextIdx = magazine.length - 1; 
    let known = chamberKnowledge[nextIdx];
    if (known === 1) return 1.0; 
    if (known === 2) return 0.0; 
    return liveCount / magazine.length;
}

function defaultShootingLogic() {
    let prob = getLiveProbability();
    if (prob === 1) fire('enemy');
    else if (prob === 0) fire('self');
    else fire(prob > 0.5 ? 'enemy' : 'self');
}

const AI_BEHAVIORS = {
    aggressive: function() {
        let prob = getLiveProbability();
        if (hp[1] <= 1 && prob > 0) { 
             if (currentItems[2].saw > 0) { useItem('saw'); return; }
             fire('enemy'); return; 
        }
        if (currentItems[2].saw > 0 && prob > 0.5) { useItem('saw'); return; }
        if (currentItems[2].handcuffs > 0 && prob > 0.6) { useItem('handcuffs'); return; }
        if (prob >= 0.4) { fire('enemy'); } else { fire('self'); }
    },
    defensive: function() {
        if (hp[2] < maxHp[2] && currentItems[2].smoke > 0) { useItem('smoke'); return; }
        let prob = getLiveProbability();
        if (currentItems[2].beer > 0 && prob < 0.3) { useItem('beer'); return; }
        if (currentItems[2].cuffs > 0 && hp[2] > 2) { useItem('cuffs'); return; }
        if (prob > 0.55) { fire('enemy'); } else { fire('self'); }
    },
    chaotic: function() {
        let prob = getLiveProbability();
        if (currentItems[2].inverter > 0 && prob < 0.3) { useItem('inverter'); return; }
        if (currentItems[2].magnifier > 0) { useItem('magnifier'); return; }
        if (currentItems[2].mirror > 0) { useItem('mirror'); return; }
        defaultShootingLogic();
    }
};

function checkSave() { const btn = document.getElementById('btn-continue'); if(btn) btn.style.display = localStorage.getItem('br_save') ? 'block' : 'none'; }
function saveGame() {
    if (gameLock && lives[1] > 0 && lives[2] > 0) return;
    if (lives[1] <= 0 || lives[2] <= 0) return; 
    const gameState = {
        hp, maxHp, lives, currentItems, magazine, chamberKnowledge,
        level, currentTurn, currentBoss, currentEvent,
        damageMultiplier, handCuffedTarget, statusEffects,
        isTwisted, selectedTalent, selectedPact, gameMode, historyLog, soundEnabled,
        bannedItems, falseAlarmBuff, itemsUsedThisTurn, safetyActive, beerCount, magnifierCount,
        damageDealtThisTurn, delayedDamageQueue, deathChipActive, visorActive, adrenalineDebt, nextShotIsDelayed,
        isRussianRoulette
    };
    localStorage.setItem('br_save', JSON.stringify(gameState));
}
function loadGame() {
    const saved = localStorage.getItem('br_save');
    if(!saved) return;
    try {
        const s = JSON.parse(saved);
        hp = s.hp; maxHp = s.maxHp; currentItems = s.currentItems;
        magazine = s.magazine; chamberKnowledge = s.chamberKnowledge;
        level = s.level; currentTurn = s.currentTurn; currentBoss = s.currentBoss;
        currentEvent = s.currentEvent; damageMultiplier = s.damageMultiplier;
        handCuffedTarget = s.handCuffedTarget; statusEffects = s.statusEffects;
        isTwisted = s.isTwisted; selectedTalent = s.selectedTalent; selectedPact = s.selectedPact || null;
        historyLog = s.historyLog || []; gameMode = s.gameMode;
        isRussianRoulette = s.isRussianRoulette || false;
        if(s.soundEnabled !== undefined) soundEnabled = s.soundEnabled;
        lives = s.lives || {1:2, 2:2}; bannedItems = s.bannedItems || [];
        falseAlarmBuff = s.falseAlarmBuff || 0; itemsUsedThisTurn = s.itemsUsedThisTurn || 0;
        safetyActive = s.safetyActive || false; beerCount = s.beerCount || 0; magnifierCount = s.magnifierCount || 0;
        damageDealtThisTurn = s.damageDealtThisTurn || false; delayedDamageQueue = s.delayedDamageQueue || { 1: [], 2: [] };
        deathChipActive = s.deathChipActive || { 1: false, 2: false }; visorActive = s.visorActive || false;
        adrenalineDebt = s.adrenalineDebt || { 1: false, 2: false }; nextShotIsDelayed = s.nextShotIsDelayed || false;

        ITEM_LIST = ALL_ITEM_LIST.filter(i => !bannedItems.includes(i));
        if (gameMode === 'pve') ITEM_LIST = ITEM_LIST.filter(i => i !== 'feint' && i !== 'visor'); 

        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('event-splash').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; document.getElementById('talent-screen').style.display = 'none'; document.getElementById('pact-screen').style.display = 'none'; document.getElementById('settings-screen').style.display = 'none'; document.getElementById('dice-overlay').style.display = 'none';
        
        gameLock = false; 
        document.getElementById('gun-display').style.transform = "perspective(500px) rotate(0deg)";
        document.getElementById('game-container').classList.remove('shaking');
        if (isRussianRoulette) document.body.classList.add('rr-mode-active'); else document.body.classList.remove('rr-mode-active');
        renderLanguage(); renderChamberUI(); updateHistoryUI();
        if (currentTurn === 1) { setControls(true); } else { setControls(false); if (gameMode === 'pve') { clearTimeout(globalTimer); globalTimer = setTimeout(aiLogic, 1000); } }
        updateLog("GAME RESUMED");
    } catch (e) { console.error("Save corrupted", e); clearSave(); }
}
function clearSave() { localStorage.removeItem('br_save'); checkSave(); }
function exitGame() { if(lives[1] > 0 && lives[2] > 0) saveGame(); clearTimeout(globalTimer); document.getElementById('settings-screen').style.display = 'none'; document.getElementById('menu-screen').style.display = 'flex'; checkSave(); }
function giveUpGame() { clearTimeout(globalTimer); document.getElementById('settings-screen').style.display = 'none'; lives[1] = 0; hp[1] = 0; checkDead(); }

function preStartGame(mode) { 
    gameMode = mode; clearSave();
    if (mode === 'pve') { document.getElementById('menu-screen').style.display = 'none'; document.getElementById('talent-screen').style.display = 'flex'; renderTalentSelection(); } 
    else { initGame(); } 
}
function selectTalent(tal) { selectedTalent = tal; document.getElementById('talent-screen').style.display = 'none'; document.getElementById('pact-screen').style.display = 'flex'; renderPactSelection(); }
function selectPact(pact) { selectedPact = pact; document.getElementById('pact-screen').style.display = 'none'; starterItemsBuffer = []; document.getElementById('starter-item-screen').style.display = 'flex'; renderItemSelection(); }

function initGame() {
    document.getElementById('menu-screen').style.display = 'none';
    currentItems = { 1: {}, 2: {} }; level = 1; bannedItems = [];
    beerCount = 0; magnifierCount = 0; isRussianRoulette = false;
    ITEM_LIST = [...ALL_ITEM_LIST];
    if (gameMode === 'pve') ITEM_LIST = ITEM_LIST.filter(i => i !== 'feint' && i !== 'visor');

    if (selectedTalent === 'ban') {
        let bannedNames = []; 
        for(let i=0; i<2; i++) { if (ITEM_LIST.length > 2) { let r = Math.floor(Math.random() * ITEM_LIST.length); let itemKey = ITEM_LIST[r]; bannedItems.push(itemKey); bannedNames.push(t('i_' + itemKey)); ITEM_LIST.splice(r, 1); } }
        if (bannedNames.length > 0) { setTimeout(() => { updateLog(`ğŸš« ç¦å¿Œç”Ÿæ•ˆï¼å·²ç§»é™¤: ${bannedNames.join(' & ')}`); }, 3000); }
    }
    
    if (gameMode === 'pvp') { maxHp = { 1: 4, 2: 4 }; } else { let bossHp = 3 + level; maxHp = { 1: 4, 2: bossHp }; }
    if (selectedPact === 'greed') maxHp[1] = Math.max(1, maxHp[1] - 1);
    if (selectedPact === 'flesh') maxHp[1] = Math.max(1, maxHp[1] - 2);
    if (selectedPact === 'half') maxHp[1] = 3;
    hp = { 1: maxHp[1], 2: maxHp[2] }; lives = { 1: 2, 2: 2 }; 

    if (gameMode === 'pve') { let proto = DEMON_ARCHETYPES[Math.floor(Math.random() * DEMON_ARCHETYPES.length)]; currentBoss = JSON.parse(JSON.stringify(proto)); currentBoss.phase2 = false; } 
    else { currentBoss = {id: 'player2'}; }

    let totalW = 0;
    EVENTS.forEach(e => totalW += e.weight);
    let r = Math.random() * totalW;
    currentEvent = EVENTS[0];
    for(let e of EVENTS) {
        if (r < e.weight) { currentEvent = e; break; }
        r -= e.weight;
    }
    updateLog(`â›ˆï¸ å½“å‰ç¯å¢ƒ: ${t('e_' + currentEvent.id)}`);
    
    window.gameJustStarted = true;

    renderLanguage(); startRound();
}

function triggerDiceRoll() {
    const dOverlay = document.getElementById('dice-overlay'); const sumP1 = document.getElementById('sum-p1'); const sumP2 = document.getElementById('sum-p2'); const msg = document.getElementById('dice-msg');
    dOverlay.style.display = 'flex'; sumP1.innerText = ''; sumP2.innerText = ''; msg.innerText = "ROLLING...";
    let rolls = 0, p1Val = 0, p2Val = 0;
    let interval = setInterval(() => {
        let r1 = Math.floor(Math.random()*6)+1, r2 = Math.floor(Math.random()*6)+1, r3 = Math.floor(Math.random()*6)+1, r4 = Math.floor(Math.random()*6)+1;
        document.getElementById('d1-1').innerText = r1; document.getElementById('d1-2').innerText = r2; document.getElementById('d2-1').innerText = r3; document.getElementById('d2-2').innerText = r4;
        p1Val = r1+r2; p2Val = r3+r4; rolls++;
        if (rolls > 15) { clearInterval(interval); sumP1.innerText = p1Val; sumP2.innerText = p2Val;
            if (p1Val === p2Val) { msg.innerText = "DRAW! REROLLING..."; setTimeout(triggerDiceRoll, 1000); } 
            else if (p1Val > p2Val) { msg.innerText = "YOU START!"; setTimeout(() => { dOverlay.style.display = 'none'; currentTurn = 1; handleTurnStart(); }, 1500); } 
            else { msg.innerText = "ENEMY STARTS!"; setTimeout(() => { dOverlay.style.display = 'none'; currentTurn = 2; handleTurnStart(); }, 1500); }
        }
    }, 100);
}

function startRound(isResurrection = false) {
    clearTimeout(globalTimer); 
    gameLock = false; 
    document.getElementById('event-splash').style.display = 'none';

    historyLog = []; falseAlarmBuff = 0; safetyActive = false; itemsUsedThisTurn = 0;
    statusEffects[1].shield = 0; statusEffects[2].shield = 0; damageDealtThisTurn = false;
    delayedDamageQueue = { 1: [], 2: [] }; deathChipActive = { 1: false, 2: false };
    adrenalineDebt = { 1: false, 2: false }; nextShotIsDelayed = false; visorActive = false;
    updateHistoryUI();

    if (!isResurrection && lives[1] === 1 && hp[1] === 1 && lives[2] === 1 && hp[2] === 1 && Math.random() < 0.1) {
        isRussianRoulette = true; document.body.classList.add('rr-mode-active');
    }

    if (gameMode === 'pvp') { hp[1] = maxHp[1]; hp[2] = maxHp[2]; } 
    else { 
        if(level > 1 && !isRussianRoulette) { 
            hp[1] = Math.min(hp[1], maxHp[1]); 
            if(hp[1]<=0) hp[1]=4; 
        } 
        hp[2] = maxHp[2]; 
    }
    if (isRussianRoulette) { hp[1] = 1; hp[2] = 1; }

    statusEffects = { 1: { jammed: false, mirror: false, shield: 0 }, 2: { jammed: false, mirror: false, shield: 0 } };
    tacticianTrapActive = (gameMode === 'pve' && currentBoss.id === 'tactician');
    
    document.getElementById('boss-card').classList.remove('enraged'); 
    if (currentBoss && currentBoss.phase2) document.getElementById('boss-card').classList.add('enraged');

    renderLanguage();

    magazine = [];
    if (isRussianRoulette) { 
        magazine = [1, 0, 0, 0, 0, 0]; 
    } else {
        let total = 6; let live;
        if (Math.random() < 0.05) { live = 6; updateLog("âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°é«˜èƒ½ååº”ï¼"); } 
        else { live = Math.floor(Math.random() * 5) + 1; }
        
        for(let i=0; i<live; i++) magazine.push(1); 
        for(let i=0; i<(total-live); i++) magazine.push(0);
        
        for (let i = magazine.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [magazine[i], magazine[j]] = [magazine[j], magazine[i]]; }
        
        if (gameMode === 'pve' && currentBoss.id === 'gambler') magazine[0] = 1; 
        if (currentEvent.id === 'shuffle') { for (let i = magazine.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [magazine[i], magazine[j]] = [magazine[j], magazine[i]]; } }
        if (selectedPact === 'eerie' && magazine.length > 0) { let r = Math.floor(Math.random() * magazine.length); magazine[r] = (magazine[r] === 1) ? 0 : 1; updateLog("ğŸ”« PACT: Eerie Mag Triggered"); }
    }

    chamberKnowledge = new Array(magazine.length).fill(0);
    if (selectedTalent === 'eye' && Math.random() < 0.3 && magazine.length>0 && !isRussianRoulette) chamberKnowledge[magazine.length-1] = (magazine[magazine.length-1]===1) ? 1 : 2;
    if (currentEvent.id === 'vision' && Math.random() < 0.25 && magazine.length>0 && !isRussianRoulette) { let idx = magazine.length - 1; chamberKnowledge[idx] = magazine[idx] === 1 ? 1 : 2; }

    if (currentEvent.id === 'fog' || currentEvent.id === 'mist') document.getElementById('table-area').classList.add('fog-active');
    else document.getElementById('table-area').classList.remove('fog-active');

    if (!isResurrection && !isRussianRoulette) {
        let baseAmount = (level === 1) ? 2 : 3; 
        if (selectedTalent === 'pack') baseAmount++; 
        if (currentEvent.id === 'drought') baseAmount = Math.max(1, baseAmount - 1);
        let multiplier = (currentEvent.id === 'carnival') ? 2 : 1;

        lootItems(1, baseAmount * multiplier);
        lootItems(2, (baseAmount + 1) * multiplier);
    }

    setControls(false); 
    renderChamberUI(); 
    updateAmmoTracker(); 
    saveGame();

    let splash = document.getElementById('event-splash');
    
    let showIntro = (window.gameJustStarted === true) && !isResurrection;

    if (showIntro) {
        if(isRussianRoulette) { 
            document.getElementById('splash-title').innerText = t('rr_trigger'); 
            document.getElementById('splash-desc').innerText = t('rr_desc'); 
            let card = document.querySelector('.event-splash-card');
            if(!card.querySelector('.rr-splash')) card.innerHTML += '<div class="rr-splash">â˜ ï¸</div>'; 
        }
        splash.style.display = 'flex';
        window.gameJustStarted = false; 
    } else {
        updateLog(t('reload'));
    }
    
    let waitTime = showIntro ? 2500 : 1000;
    if (isResurrection) waitTime = 1000;

    globalTimer = setTimeout(() => {
        splash.style.display = 'none'; 
        
        damageMultiplier = 1; 
        handCuffedTarget = 0; 
        gameLock = false; 
        
        if (isResurrection) { 
            currentTurn = 1; 
            handleTurnStart(); 
        } else { 
            triggerDiceRoll(); 
        }
        saveGame();
    }, waitTime);
    
    renderUI();
}

function activePlayerAction(targetType) { if(!gameLock) fire(targetType); }

function fire(targetType) {
    setControls(false); gameLock = true; 
    let gun = document.getElementById('gun-display'); gun.style.transform = "scale(1.3) rotate(-15deg)";
    
    globalTimer = setTimeout(() => {
        let bullet = magazine.pop(); chamberKnowledge.pop(); 
        if (visorActive) { visorActive = false; updateLog("ğŸ­ VISOR EXPIRED"); }
        
        let isDud = (bullet === 1 && Math.random() < 0.03 && !isTwisted && !isRussianRoulette);
        if (isDud) { bullet = 0; updateLog(t('mech_dud')); } 
        renderChamberUI(); updateAmmoTracker(); 
        
        let isVolatileTrigger = false;
        if (currentEvent.id === 'volatile' && bullet === 0 && Math.random() < 0.3 && !isRussianRoulette) { bullet = 1; isVolatileTrigger = true; }

        let isLive = (bullet === 1); let baseDmg = 1;

        if (!isRussianRoulette) {
            if (isTwisted && isLive) baseDmg++; 
            if (selectedPact === 'power' && isLive) baseDmg++; 
            if (selectedPact === 'half' && isLive) baseDmg++;
            if (gameMode === 'pve' && currentBoss.id === 'butcher' && currentTurn === 2 && isLive && currentBoss.phase2) baseDmg += 2;
            else if (gameMode === 'pve' && currentBoss.id === 'butcher' && currentTurn === 2 && isLive) baseDmg += 1;
            if (isLive && falseAlarmBuff > 0) { baseDmg += falseAlarmBuff; falseAlarmBuff = 0; }
            if (isLive && selectedTalent === 'quick' && itemsUsedThisTurn === 0) baseDmg++;
        } else { baseDmg = 999; }

        let dmg = baseDmg * damageMultiplier; 
        if (currentEvent.id === 'overheat' && isLive && !isRussianRoulette) dmg += consecutiveLiveShots++; 
        if (!isLive) consecutiveLiveShots = 0;
        if (targetType === 'self' && isLive && selectedTalent === 'pain' && !isRussianRoulette) dmg = Math.max(1, dmg - 1);
        
        if (targetType === 'self' && isDevilDealActive) {
            if (isLive) { dmg *= 2; updateLog(t('deal_fail')); } else { lootItems(currentTurn, 2); updateLog(t('deal_success')); }
            isDevilDealActive = false; 
        }
        
        if (targetType === 'self' && currentEvent.id === 'blood' && isLive && !isRussianRoulette) dmg *= 2;
        
        if (nextShotIsDelayed && isLive) {
            nextShotIsDelayed = false; delayedDamageQueue[targetType === 'self' ? currentTurn : (currentTurn===1?2:1)].push({dmg: dmg, turns: 2});
            dmg = 0; updateLog("ğŸ§ª POISON APPLIED (2 Turns)"); document.getElementById('table-area').style.borderColor = "#2ecc71"; setTimeout(()=>document.getElementById('table-area').style.borderColor = "#333", 500);
        }

        let historyVal = isLive ? 1 : 0; if (visorActive && gameMode === 'pvp') historyVal = (historyVal === 1) ? 0 : 1; 
        historyLog.push(historyVal); updateHistoryUI();

        let shooter = currentTurn; let opponent = (currentTurn === 1) ? 2 : 1; let victim = (targetType === 'self') ? shooter : opponent; let shooterName = getShooterName(shooter);

        document.getElementById('game-container').classList.add('shaking');
        globalTimer = setTimeout(()=> { document.getElementById('game-container').classList.remove('shaking'); gun.style.transform = "perspective(500px) rotateY(0deg) rotateX(0deg)"; }, 300);

        let skipTurnEffect = false;

        if (isLive && !isDud) {
            if (gameMode === 'pve' && currentBoss.id === 'doctor' && shooter === 2 && targetType === 'enemy') {
                delayedDamageQueue[1].push({dmg: 1, turns: 2}); updateLog("ğŸ¦  ç˜ŸåŒ»çš„å­å¼¹å¸¦æœ‰å‰§æ¯’ï¼(2å›åˆåå‘ä½œ)");
                document.getElementById('table-area').style.borderColor = "#2ecc71"; setTimeout(()=>document.getElementById('table-area').style.borderColor = "#333", 500);
            }
            if (selectedPact === 'echo' && Math.random() < 0.25 && !isRussianRoulette) { magazine.unshift(1); chamberKnowledge.unshift(0); updateAmmoTracker(); renderChamberUI(); updateLog("ğŸ”„ ECHO BULLET RETURNED!"); }
            if (statusEffects[victim].shield > 0 && dmg > 0) { statusEffects[victim].shield--; dmg = 0; updateLog(`ğŸ›¡ï¸ ${getShooterName(victim)} BLOCKED DAMAGE!`); }
            
            if (gameMode === 'pve' && victim === 2 && currentBoss.id === 'butcher' && dmg > 2) { dmg = 2; updateLog("ğŸ›¡ï¸ å± å¤«çš„åšå®è„‚è‚ªç¼“å†²äº†ä¼¤å®³ï¼(Max 2)"); }
            
            if (dmg > 0) {
                if(isVolatileTrigger) updateLog("ğŸ§¨ VOLATILE! " + t('shot_live', {shooter: shooterName, dmg: dmg})); else updateLog(t('shot_live', {shooter: shooterName, dmg: dmg}));
                hp[victim] -= dmg; if(targetType === 'enemy') { document.getElementById('table-area').classList.add('flash-red'); damageDealtThisTurn = true; }
            }
            globalTimer = setTimeout(()=>document.getElementById('table-area').classList.remove('flash-red'), 200);
            
            if (shooter === 1 && victim === 1) unlockAchievement(21); if (dmg >= 3 && hp[victim] <= 0 && targetType === 'enemy') unlockAchievement(27);
            damageMultiplier = 1; renderUI(); if (victim === 1 && hp[1] > 0 && dmg > 0) triggerTaunt('hit');

            if (gameMode === 'pve' && victim === 2 && hp[2] < maxHp[2]/2 && !currentBoss.phase2 && !isRussianRoulette) {
                triggerEnrage(); globalTimer = setTimeout(() => { if (!checkDead()) { if (magazine.length === 0) startRound(); else switchTurn(opponent); } }, 2600); return;
            }
            if (checkDead()) return; 
            if (isRussianRoulette && isLive) { return; } 

            if (currentEvent.id === 'static' && Math.random() < 0.25) {
                updateLog(t('static_trigger'));
                if (magazine.length === 0) globalTimer = setTimeout(startRound, 2000);
                else globalTimer = setTimeout(() => handleTurnStart(), 1500);
                return;
            }

            if (magazine.length === 0) globalTimer = setTimeout(startRound, 2000); else switchTurn(opponent); 
        } 
        else {
            damageMultiplier = 1; 
            if (isDud) { 
                triggerTaunt('miss'); if (magazine.length === 0 && !checkDead()) { globalTimer = setTimeout(startRound, 2000); } else { switchTurn(opponent); } return; 
            }
            if (targetType === 'self' && selectedPact === 'flesh') { statusEffects[1].shield++; updateLog("ğŸ©¸ FLESH PACT: SHIELD UP"); }
            if (targetType === 'enemy' && selectedPact === 'strict') { skipTurnEffect = true; updateLog("âš–ï¸ STRICT PACT: SKIP TURN"); }
            if (selectedPact === 'greed' && !isRussianRoulette) { lootItems(currentTurn, 1); updateLog(t('c_greed_name')); }
            
            if ((isTwisted || selectedPact === 'power') && !isRussianRoulette) {
                for (let i = magazine.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [magazine[i], magazine[j]] = [magazine[j], magazine[i]]; }
                chamberKnowledge.fill(0); renderChamberUI(); historyLog.push(2); updateHistoryUI(); 
            }

            if (targetType === 'self') {
                unlockAchievement(3); if (hp[1] === 1) unlockAchievement(28); if (selectedTalent === 'alarm') falseAlarmBuff++;
                if (selectedTalent === 'boom' && !isRussianRoulette) { hp[opponent]--; updateLog("ğŸ’¥ SELF-DESTRUCT DMG"); damageDealtThisTurn = true; renderUI(); if(checkDead()) return; }
                
                let keepTurn = true;
                if (currentEvent.id === 'blood' && selectedTalent !== 'luck' && !isRussianRoulette) keepTurn = false;
                if (currentEvent.id === 'fair' && !isRussianRoulette) keepTurn = false;
                if (isRussianRoulette) keepTurn = false;

                if (!keepTurn) { updateLog(t('shot_blank', {shooter: shooterName})); triggerTaunt('miss'); if (magazine.length === 0 && !checkDead()) globalTimer = setTimeout(startRound, 2000); else switchTurn(opponent); }
                else { 
                    updateLog(t('shot_blank', {shooter: shooterName}) + " " + t('safe_bet')); 
                    
                    if (currentEvent.id === 'static' && Math.random() < 0.25) updateLog(t('static_trigger'));

                    if (magazine.length === 0 && !checkDead()) globalTimer = setTimeout(startRound, 2000); else globalTimer = setTimeout(() => handleTurnStart(), 1000); 
                }
            } 
            else {
                updateLog(t('shot_blank_miss', {shooter: shooterName})); triggerTaunt('miss'); if(skipTurnEffect) handCuffedTarget = shooter; 
                
                if (currentEvent.id === 'static' && Math.random() < 0.25) {
                     updateLog(t('static_trigger'));
                     if (magazine.length === 0 && !checkDead()) globalTimer = setTimeout(startRound, 2000); 
                     else globalTimer = setTimeout(() => handleTurnStart(), 1500); 
                     return;
                }

                if (magazine.length === 0 && !checkDead()) globalTimer = setTimeout(startRound, 2000); else switchTurn(opponent);
            }
        }
    }, 500);
}

function switchTurn(nextPlayer) {
    if (currentTurn === 1 && selectedPact === 'acute' && !damageDealtThisTurn && !isRussianRoulette) { hp[1]--; updateLog("âŒ› ACUTE DEATH: -1 HP"); renderUI(); if(checkDead()) return; }
    if (handCuffedTarget === nextPlayer && !isRussianRoulette) { let name = getShooterName(nextPlayer); updateLog(`ğŸ”— ${name} (SKIP)`); handCuffedTarget = 0; switchTurn((nextPlayer===1)?2:1); return; }
    currentTurn = nextPlayer; handleTurnStart();
}

function handleTurnStart() {
    gameLock = false; itemsUsedThisTurn = 0; damageDealtThisTurn = false; updateTurnUI();
    if (currentTurn === 2 && gameMode === 'pve' && currentBoss.id === 'gambler') {
        let pItems = Object.keys(currentItems[1]).filter(k => currentItems[1][k] > 0);
        if (pItems.length > 0 && Math.random() < 0.6) { 
            let stolen = pItems[Math.floor(Math.random() * pItems.length)]; 
            currentItems[1][stolen]--; currentItems[2][stolen] = (currentItems[2][stolen] || 0) + 1; 
            updateLog(`ğŸƒ èµŒå¾’é¡ºæ‰‹ç‰µç¾Šæ‹¿èµ°äº†ä½ çš„ ${t('i_'+stolen)}!`); renderUI(); 
        }
    }
    if (adrenalineDebt[currentTurn]) { hp[currentTurn]--; adrenalineDebt[currentTurn] = false; updateLog("ğŸ’‰ ADRENALINE CRASH: -1 HP"); renderUI(); if (checkDead()) return; }
    
    let queue = delayedDamageQueue[currentTurn];
    if (queue.length > 0) {
        for (let i = queue.length - 1; i >= 0; i--) { queue[i].turns--; if (queue[i].turns <= 0) { hp[currentTurn] -= queue[i].dmg; updateLog(`ğŸ§ª POISON: -${queue[i].dmg} HP`); queue.splice(i, 1); } }
        renderUI(); if (checkDead()) return;
    }
    if (gameMode === 'pve' && currentBoss.id === 'doctor' && currentTurn === 2 && !isRussianRoulette) { if (hp[2] < maxHp[2] && Math.random() < 0.3) { hp[2]++; updateLog("ğŸ’Š Doctor Heals"); renderUI(); } }
    
    isDevilDealActive = false; let btnSelf = document.getElementById('btn-self'); btnSelf.classList.remove('cursed-btn'); 
    if (currentTurn === 1 && Math.random() < 0.3 && !isRussianRoulette) { isDevilDealActive = true; btnSelf.classList.add('cursed-btn'); }
    
    if (gameMode === 'pve') { if (currentTurn === 1) setControls(true); else { setControls(false); globalTimer = setTimeout(aiLogic, 1500); } } else { setControls(true); }
    saveGame();
}

function useItem(name) {
    if (gameLock) return; if (isRussianRoulette) return; 
    if (gameMode === 'pve' && currentTurn === 1 && document.getElementById('btn-self').disabled) return;
    if (currentItems[currentTurn][name] <= 0) return;

    if (currentEvent.id === 'rust' && Math.random() < 0.3) {
        currentItems[currentTurn][name]--; itemsUsedThisTurn++; 
        updateLog(t('rust_fail')); renderUI();
        if (gameMode === 'pve' && currentTurn === 2) globalTimer = setTimeout(aiLogic, 1000);
        return; 
    }

    if (currentEvent.id === 'sacrifice') { 
        if (hp[currentTurn] > 1) { hp[currentTurn]--; renderUI(); updateLog("ğŸ©¸ çŒ®ç¥­ï¼šå¤±å» 1 ç‚¹ç”Ÿå‘½å€¼"); } 
        else { updateLog("ğŸ©¸ æ¿’æ­»ç‰¹æƒï¼šå…é™¤äº†çŒ®ç¥­ä»£ä»·ï¼"); } 
    }

    currentItems[currentTurn][name]--;
    let isFakeFail = false; let isDoubleEffect = false;
    if (currentTurn === 1 && selectedPact === 'eye') { if (Math.random() < 0.5) { isFakeFail = true; isDoubleEffect = true; } }
    
    if (feintActive) { feintActive = false; updateLog(`ğŸ­ ${getShooterName(currentTurn)} FEINTS ${t('i_'+name)}`); if (currentTurn === 1) unlockAchievement(18); renderUI(); return; }

    itemsUsedThisTurn++;
    if (currentTurn === 1) {
        if(name==='smoke') unlockAchievement(2); if(name==='magnifier') { magnifierCount++; if(magnifierCount>=3) unlockAchievement(5); }
        if(name==='beer') { beerCount++; if(beerCount>=3) unlockAchievement(13); } if(name==='mirror') unlockAchievement(15);
        if(name==='preload') unlockAchievement(17); if(name==='saw') unlockAchievement(22); if(name==='cuffs') unlockAchievement(23);
        if(name==='inverter') unlockAchievement(24); if(name==='jammer') unlockAchievement(25);
        let totalItems = 0; ITEM_LIST.forEach(k=> totalItems += currentItems[1][k]); if(totalItems >= 6) unlockAchievement(26);
    }

    if (gameMode === 'pve' && currentBoss.id === 'tactician' && currentTurn === 1 && tacticianTrapActive) { tacticianTrapActive = false; updateLog(t('tact_block', {item: t('i_'+name)})); renderUI(); return; }

    let opponent = (currentTurn === 1) ? 2 : 1; let effectiveUser = currentTurn; let userName = getShooterName(currentTurn);
    if (statusEffects[currentTurn].jammed) { statusEffects[currentTurn].jammed = false; updateLog(t('item_jammed', {item: t('i_'+name)})); renderUI(); if (gameMode === 'pve' && currentTurn === 2) globalTimer = setTimeout(aiLogic, 1000); return; }
    let eName = getShooterName(effectiveUser); 

    if (name === 'magnifier') { 
        let idx = magazine.length - 1; let isFake = (selectedTalent === 'mis' && Math.random() < 0.5); 
        if (gameMode === 'pve' && currentBoss.id === 'tactician' && currentTurn === 1 && Math.random() < 0.5) { isFake = true; updateLog("ğŸ“¡ æˆ˜æœ¯å®¶å¹²æ‰°äº†ä½ çš„ä¾¦æŸ¥è®¾å¤‡ï¼"); }
        let realState = magazine[idx]; let shownState = isFake ? (realState===1?0:1) : realState;
        if (effectiveUser === 1) { chamberKnowledge[idx] = (shownState === 1) ? 1 : 2; renderChamberUI(); updateLog(`ğŸ” ${shownState===1 ? "LIVE" : "BLANK"}`); } else updateLog(`ğŸ” ${eName} checked...`);
    } 
    else if (name === 'beer') { let b = magazine.pop(); chamberKnowledge.pop(); renderChamberUI(); updateAmmoTracker(); historyLog.push(b===1?1:0); updateHistoryUI(); updateLog(`ğŸº ${eName}: ${b===1?"LIVE":"BLANK"}`); if (magazine.length===0) globalTimer = setTimeout(startRound, 1500); }
    else if (name === 'saw') { damageMultiplier = isDoubleEffect ? 4 : 2; updateLog(`ğŸªš ${eName} SAW ${isDoubleEffect?'(x4!)':''}`); }
    else if (name === 'smoke') { 
        if (currentEvent.id === 'blood_moon') { updateLog(t('no_heal_blood')); } else {
            let healAmt = isDoubleEffect ? 2 : 1; if (hp[effectiveUser] < maxHp[effectiveUser]) hp[effectiveUser] = Math.min(maxHp[effectiveUser], hp[effectiveUser]+healAmt); updateLog(`ğŸš¬ ${eName} +${healAmt} HP`); 
        }
    }
    else if (name === 'expired_med') {
        let roll = Math.random();
        if (currentEvent.id === 'blood_moon') {
            if (roll < 0.5) updateLog(t('no_heal_blood'));
            else { hp[effectiveUser]--; updateLog(t('med_hurt')); damageDealtThisTurn = true; }
        } else {
            if (roll < 0.5) { if (hp[effectiveUser] < maxHp[effectiveUser]) { hp[effectiveUser]++; updateLog(t('med_heal')); } else updateLog(t('med_heal') + " (MAX)"); } 
            else { hp[effectiveUser]--; updateLog(t('med_hurt')); damageDealtThisTurn = true; }
        }
    }
    else if (name === 'cuffs') { handCuffedTarget = opponent; updateLog(`ğŸ”— ${eName} CUFFS`); }
    else if (name === 'inverter') { let v = magazine.pop(); magazine.push(v===1?0:1); let idx = magazine.length-1; if (chamberKnowledge[idx] === 1) chamberKnowledge[idx] = 2; else if (chamberKnowledge[idx] === 2) chamberKnowledge[idx] = 1; renderChamberUI(); updateLog(`ğŸ”„ ${eName} INVERT`); historyLog.push(2); updateHistoryUI(); }
    else if (name === 'jammer') { statusEffects[opponent].jammed = true; updateLog(`ğŸš« ${eName} JAMMER`); if(effectiveUser===1) unlockAchievement(9); }
    else if (name === 'mirror') { 
        if (currentTurn === 1) {
            let enemyTotal = 0; for(let k in currentItems[2]) enemyTotal += currentItems[2][k];
            if (enemyTotal <= 0) { updateLog("ğŸ”® å¯¹æ‰‹ç©ºç©ºå¦‚ä¹Ÿï¼Œæ— æ³•çªƒå–ï¼"); currentItems[1]['mirror']++; itemsUsedThisTurn--; return; }
            if (mirrorSelectionMode) { window.cancelMirrorMode(); } else { mirrorSelectionMode = true; updateLog("ğŸ”® è¯·ç‚¹å‡»æ•Œäººçš„é“å…·è¿›è¡Œçªƒå–..."); currentItems[1]['mirror']--; itemsUsedThisTurn++; renderMirrorUI(true); }
        } else {
            let pItems = Object.keys(currentItems[1]).filter(k => currentItems[1][k] > 0);
            if (pItems.length > 0) { let stolen = pItems[Math.floor(Math.random() * pItems.length)]; currentItems[1][stolen]--; currentItems[2][stolen] = (currentItems[2][stolen] || 0) + 1; updateLog(`ğŸ”® AI çªƒå–äº†ä½ çš„ ${t('i_'+stolen)}!`); } else { updateLog(`ğŸ”® AI æµªè´¹äº†é­”é•œ...`); }
        }
        renderUI(); return; 
    }
    else if (name === 'preload') { magazine.unshift(1); chamberKnowledge.unshift(0); updateAmmoTracker(); renderChamberUI(); updateLog(`â³ ${eName} PRELOAD`); }
    else if (name === 'feint') { feintActive = true; updateLog(`ğŸª¤ ${eName} FEINT READY`); }
    else if (name === 'safety') { safetyActive = true; updateLog(`ğŸ§· ${eName} SAFETY ON`); }
    else if (name === 'hourglass') { if (magazine.length > 1) { let shell = magazine.pop(); let know = chamberKnowledge.pop(); magazine.unshift(shell); chamberKnowledge.unshift(know); updateLog(`â³ ${eName} HOURGLASS`); renderChamberUI(); } else { updateLog("â³ USELESS NOW..."); } }
    else if (name === 'visor') { visorActive = true; updateLog(`ğŸ­ ${eName} VISOR ON`); }
    else if (name === 'delay_shell') { nextShotIsDelayed = true; updateLog(`ğŸ§ª ${eName} COATS BULLET`); }
    else if (name === 'death_chip') { deathChipActive[currentTurn] = true; updateLog(`âš°ï¸ ${eName} DEATH BARGAIN`); }
    else if (name === 'adrenaline') { adrenalineDebt[currentTurn] = true; itemsUsedThisTurn = -1; updateLog(`ğŸ’‰ ${eName} RUSH! (-1 HP NEXT)`); handCuffedTarget = opponent; }
    else if (name === 'phone') { let unknownIndices = []; for(let i=0; i<magazine.length; i++) { if(chamberKnowledge[i] === 0) unknownIndices.push(i); } if(unknownIndices.length > 0) { let idx = unknownIndices[Math.floor(Math.random() * unknownIndices.length)]; let state = magazine[idx]; if(effectiveUser === 1) { chamberKnowledge[idx] = (state === 1) ? 1 : 2; renderChamberUI(); updateLog(`ğŸ“± FUTURE: #${magazine.length - idx} is ${state===1?'LIVE':'BLANK'}`); } else { updateLog(`ğŸ“± ${eName} HACKED FUTURE...`); } } else { updateLog(`ğŸ“± NO SIGNAL...`); } }

    renderUI(); saveGame();
    if (isFakeFail) { updateLog("ğŸ‘ï¸ DECEPTIVE EYE: CRITICAL SUCCESS!"); }
    if (gameMode === 'pve' && currentTurn === 2 && magazine.length > 0) globalTimer = setTimeout(aiLogic, 1500);
}

window.performMirrorSteal = function(targetItemKey) {
    if (!mirrorSelectionMode || gameLock) return;
    if (currentItems[2][targetItemKey] <= 0) return;
    if (currentItems[1]['mirror'] > 0) { currentItems[1]['mirror']--; itemsUsedThisTurn++; unlockAchievement(15); } else { return; }
    currentItems[2][targetItemKey]--; currentItems[1][targetItemKey] = (currentItems[1][targetItemKey] || 0) + 1;
    updateLog(`ğŸ”® STOLE ${t('i_' + targetItemKey)}!`); showItemToast([targetItemKey], 1);
    mirrorSelectionMode = false; renderUI(); saveGame();
};

function aiLogic() {
    if (magazine.length === 0 || hp[2] <= 0 || gameLock) return;
    if (isRussianRoulette) { globalTimer = setTimeout(() => fire('self'), 1000); return; }
    let style = currentBoss && currentBoss.style ? currentBoss.style : 'chaotic';
    let strategy = AI_BEHAVIORS[style] || AI_BEHAVIORS.chaotic;
    globalTimer = setTimeout(() => { strategy(); }, 1000);
}

function triggerEnrage() {
    if (!currentBoss || currentBoss.phase2) return;
    currentBoss.phase2 = true; gameLock = true; document.getElementById('boss-card').classList.add('enraged');
    let splash = document.getElementById('event-splash'); let card = document.querySelector('.event-splash-card'); card.classList.add('enrage-mode');
    document.getElementById('splash-title').innerText = t('enrage_title'); document.getElementById('splash-desc').innerText = t('enrage_' + currentBoss.id);
    splash.style.display = 'flex';
    
    let gainedItems = [];
    if (currentBoss.id === 'butcher') { currentItems[2].saw++; gainedItems.push('saw'); }
    if (currentBoss.id === 'doctor') { hp[2] = Math.min(hp[2]+2, maxHp[2]); renderUI(); }
    if (currentBoss.id === 'tactician') { currentItems[2].cuffs++; handCuffedTarget = 1; gainedItems.push('cuffs'); }
    if (currentBoss.id === 'gambler') { 
        let p1Items = Object.keys(currentItems[1]).filter(k => currentItems[1][k] > 0); 
        if(p1Items.length > 0) { let stolen = p1Items[Math.floor(Math.random()*p1Items.length)]; currentItems[1][stolen]--; currentItems[2][stolen] = (currentItems[2][stolen] || 0) + 1; gainedItems.push(stolen); } 
    }
    if(gainedItems.length > 0) showItemToast(gainedItems, 2);
    setTimeout(() => { splash.style.display = 'none'; card.classList.remove('enrage-mode'); gameLock = false; }, 2500);
}

function checkDead() {
    if (hp[1] <= 0 && safetyActive && !isRussianRoulette) { hp[1] = 1; safetyActive = false; updateLog("ğŸ§· SAFETY SAVED YOU!"); unlockAchievement(16); renderUI(); return false; }
    for (let pid = 1; pid <= 2; pid++) { if (hp[pid] <= 0 && deathChipActive[pid]) { let enemy = (pid === 1) ? 2 : 1; hp[enemy] -= 2; deathChipActive[pid] = false; updateLog(t('mech_mutual')); renderUI(); } }
    for (let pid = 1; pid <= 2; pid++) {
        if (hp[pid] <= 0) {
            if (lives[pid] > 1) {
                if (pid === 2 && currentBoss.id === 'gambler') { triggerSicBo(); return false; }
                lives[pid]--; hp[pid] = maxHp[pid]; updateLog(t('resurrect', {name: getShooterName(pid)})); startRound(true); return false; 
            }
        }
    }
    let p1Dead = hp[1] <= 0; let p2Dead = hp[2] <= 0;
    if (p1Dead || p2Dead) {
        setControls(false); gameLock = true; clearSave();
        setTimeout(() => {
            let overlay = document.getElementById('overlay'); let title = document.getElementById('win-title'); let desc = document.getElementById('win-desc'); let comment = document.getElementById('win-comment'); let cardBox = document.getElementById('card-display'); let restartBtn = document.getElementById('restart-btn');
            overlay.style.display = 'flex'; requestAnimationFrame(() => overlay.style.opacity = 1); cardBox.innerHTML = '';
            if (p1Dead && p2Dead) { title.innerText = t('win_draw'); title.style.color = "#7f8c8d"; desc.innerText = t('win_draw_desc'); comment.innerText = "â€œ...â€"; restartBtn.style.display = 'block'; }
            else if (p1Dead) { title.innerText = t('win_died'); title.style.color = "#ff4757"; desc.innerText = t('win_kill', {name: getShooterName(2)}); restartBtn.style.display = 'block'; if(selectedPact) comment.innerText = t('eval_greedy'); else comment.innerText = t('eval_sad'); triggerTaunt('win'); } 
            else {
                title.innerText = t('win_vic'); title.style.color = "var(--accent-gold)"; desc.innerText = t('win_reward', {name: getShooterName(2)}); restartBtn.style.display = 'none'; 
                if (hp[1] === maxHp[1]) comment.innerText = t('eval_perfect'); else if (hp[1] === 1) comment.innerText = t('eval_clutch'); else if (historyLog.filter(x=>x===1).length > historyLog.filter(x=>x===0).length) comment.innerText = t('eval_brutal'); else comment.innerText = t('eval_lucky');
                if (hp[1] === 1) unlockAchievement(6); if (hp[1] === maxHp[1]) unlockAchievement(10); if (isTwisted) unlockAchievement(7);
                if (currentBoss.id === 'butcher') unlockAchievement(8); if (currentBoss.id === 'tactician') unlockAchievement(9); if (currentBoss.id === 'doctor') unlockAchievement(11);
                if (currentBoss.id === 'gambler') unlockAchievement(12); if (selectedPact) unlockAchievement(19); if (currentEvent.id === 'fog') unlockAchievement(20);
                if (currentEvent.id === 'sacrifice') unlockAchievement(29); if (level >= 3) unlockAchievement(30);
                buffPool.forEach(b => {
                    let div = document.createElement('div'); div.className = 'card'; div.innerHTML = `<h3 style="margin:0 0 5px 0; color:#fff">${t(b.key)}</h3><div style="font-size:0.8rem;color:#888">${t(b.descKey)}</div>`;
                    div.onclick = () => { if(b.id==='heal') hp[1]=maxHp[1]; if(b.id==='hp_up') {maxHp[1]++; hp[1]=maxHp[1];} if(b.id==='supplies') lootItems(1, 4); if(b.id==='tech') { currentItems[1].jammer++; currentItems[1].mirror++; } level++; maxHp[2]++; currentBoss = DEMON_ARCHETYPES[Math.floor(Math.random() * DEMON_ARCHETYPES.length)]; renderLanguage(); overlay.style.opacity = 0; setTimeout(() => { overlay.style.display = 'none'; startRound(); }, 500); };
                    cardBox.appendChild(div);
                });
            }
        }, 1000);
        return true;
    }
    return false;
}

function getWeightedRandomItem() {
    let validItems = ITEM_LIST.filter(key => ITEM_WEIGHTS[key] !== undefined);
    let totalWeight = 0; validItems.forEach(key => totalWeight += ITEM_WEIGHTS[key]);
    let random = Math.random() * totalWeight;
    for (let i = 0; i < validItems.length; i++) {
        let key = validItems[i]; let weight = ITEM_WEIGHTS[key];
        if (random < weight) { return key; } random -= weight;
    }
    return validItems[0];
}

function lootItems(pid, count) {
    let gained = []; let currentTotal = 0; for (let k in currentItems[pid]) currentTotal += currentItems[pid][k];
    for(let i = 0; i < count; i++) {
        if (currentTotal >= MAX_ITEMS) { if (pid === 1) updateLog("ğŸ’ èƒŒåŒ…å·²æ»¡ï¼"); break; }
        let item = getWeightedRandomItem();
        currentItems[pid][item] = (currentItems[pid][item] || 0) + 1; gained.push(item); currentTotal++;
    }
    if(gained.length > 0) showItemToast(gained, pid);
}

function toggleStarterItem(key) {
    const idx = starterItemsBuffer.indexOf(key);
    if (idx > -1) { starterItemsBuffer.splice(idx, 1); document.getElementById('starter-btn-' + key).classList.remove('selected'); } 
    else { if (starterItemsBuffer.length < 2) { starterItemsBuffer.push(key); document.getElementById('starter-btn-' + key).classList.add('selected'); } else { return; } }
    const allBtns = document.querySelectorAll('.starter-select-btn');
    allBtns.forEach(b => { if (starterItemsBuffer.length >= 2 && !b.classList.contains('selected')) b.classList.add('dimmed'); else b.classList.remove('dimmed'); });
    updateStarterConfirmBtn();
}

function confirmStarterItems() {
    document.getElementById('starter-item-screen').style.display = 'none'; initGame(); 
    starterItemsBuffer.forEach(item => { currentItems[1][item] = (currentItems[1][item] || 0) + 1; });
    renderItemsGrid(); renderUI(); if(starterItemsBuffer.length > 0) showItemToast(starterItemsBuffer, 1);
}

function randomizeStarterItems() {
    starterItemsBuffer = []; const allBtns = document.querySelectorAll('.starter-select-btn');
    allBtns.forEach(b => { b.classList.remove('selected'); b.classList.remove('dimmed'); });
    let pool = ALL_ITEM_LIST.filter(i => i !== 'feint' && i !== 'visor');
    while (starterItemsBuffer.length < 2) { let r = Math.floor(Math.random() * pool.length); let item = pool[r]; if (!starterItemsBuffer.includes(item)) starterItemsBuffer.push(item); }
    starterItemsBuffer.forEach(key => { let btn = document.getElementById('starter-btn-' + key); if (btn) btn.classList.add('selected'); });
    allBtns.forEach(b => { if (!b.classList.contains('selected')) b.classList.add('dimmed'); });
    updateStarterConfirmBtn();
}

function setControls(enable) { document.getElementById('btn-self').disabled = !enable; document.getElementById('btn-enemy').disabled = isRussianRoulette ? true : !enable; document.querySelectorAll('.item-btn').forEach(b => b.disabled = isRussianRoulette ? true : !enable); }

function triggerSicBo() {
    gameLock = true; document.getElementById('sicbo-screen').style.display = 'flex'; document.getElementById('sicbo-btn-group').style.display = 'flex'; 
    document.getElementById('sicbo-result').innerText = ""; document.getElementById('sb-d1').innerText = "?"; document.getElementById('sb-d2').innerText = "?"; document.getElementById('sb-d3').innerText = "?";
}
window.resolveSicBo = function(choice) {
    document.getElementById('sicbo-btn-group').style.display = 'none';
    let d1 = Math.floor(Math.random() * 6) + 1; let d2 = Math.floor(Math.random() * 6) + 1; let d3 = Math.floor(Math.random() * 6) + 1; let sum = d1 + d2 + d3;
    document.getElementById('sb-d1').innerText = d1; document.getElementById('sb-d2').innerText = d2; document.getElementById('sb-d3').innerText = d3;
    let isTriple = (d1 === d2 && d2 === d3); let resultType = (sum >= 11 && sum <= 17) ? 'big' : 'small'; let msgEl = document.getElementById('sicbo-result');

    if (isTriple) {
        msgEl.innerText = `âš  å›´éª° (TRIPLE) ${d1}-${d2}-${d3}ï¼`; msgEl.style.color = "var(--accent-red)"; document.querySelector('.sicbo-content').classList.add('triple-kill');
        setTimeout(() => {
            document.getElementById('sicbo-screen').style.display = 'none'; document.querySelector('.sicbo-content').classList.remove('triple-kill');
            lives[1]--; hp[1] = 0; lives[2]--; hp[2] = maxHp[2]; updateLog("â˜ ï¸ å›´éª°ï¼ä½ å¤±å»äº†ä¸€æ¡å‘½ï¼");
            if (lives[1] <= 0) { checkDead(); } else { hp[1] = maxHp[1]; startRound(true); }
        }, 2000); return;
    }
    let playerWin = (choice === resultType);
    msgEl.innerText = `${sum} ç‚¹ (${resultType.toUpperCase()}) - ${playerWin ? "WIN" : "LOSE"}`; msgEl.style.color = playerWin ? "var(--accent-green)" : "var(--accent-red)";
    setTimeout(() => {
        document.getElementById('sicbo-screen').style.display = 'none'; lives[2]--;
        if (playerWin) { updateLog("ğŸ² èµŒèµ¢äº†ï¼èµŒå¾’å®¶å¾’å››å£ï¼"); currentItems[2] = {}; hp[2] = Math.floor(maxHp[2] / 2); } 
        else { updateLog("ğŸ² èµŒè¾“äº†ï¼ä½ å¤±å»äº†ä¸€åˆ‡ï¼"); currentItems[1] = {}; hp[2] = maxHp[2]; hp[1] = Math.max(1, Math.floor(hp[1] / 2)); }
        renderUI(); startRound(true);
    }, 2000);
};
function getShooterName(pid) {
    if (pid === 1) return t('label_you');
    if (gameMode === 'pvp') return t('label_p2');
    if (currentBoss && currentBoss.id) return t('b_' + currentBoss.id);
    return "UNKNOWN";
}

/* =========================================
   4. ui.js åŸå§‹å†…å®¹
   ========================================= */
function t(key, params = {}) {
    let str = TEXT[curLang][key];
    if (!str) return key;
    for (let p in params) str = str.replace(`{${p}}`, params[p]);
    return str;
}

function renderLanguage() {
    document.getElementById('btn-pve').innerText = t('pve_btn');
    document.getElementById('btn-pvp').innerText = t('pvp_btn');
    document.getElementById('btn-continue').innerText = t('btn_continue');
    document.getElementById('restart-btn').innerText = t('restart_btn');
    document.getElementById('txt-twist').innerText = isTwisted ? t('twist_on') : t('twist_off');
    document.getElementById('subtitle-fix').innerText = t('subtitle_fix');
    document.getElementById('txt-self').innerText = isRussianRoulette ? t('btn_pull') : t('btn_self');
    document.getElementById('txt-enemy').innerText = t('btn_enemy');
    document.querySelector('#btn-self small').innerText = isRussianRoulette ? "" : t('sub_self');
    document.querySelector('#btn-enemy small').innerText = t('sub_enemy');
    document.getElementById('label-demon').innerText = (gameMode === 'pvp') ? t('label_p2') : t('label_demon');
    document.getElementById('label-you').innerText = (gameMode === 'pvp') ? t('label_p1') : t('label_you');
    document.querySelector('.settings-content button:nth-of-type(1)').innerText = t('s_resume');
    document.querySelector('.settings-content button:nth-of-type(2)').innerText = t('s_menu');
    document.querySelector('.settings-content button:nth-of-type(3)').innerText = t('s_giveup');
    document.getElementById('txt-sound').innerText = t('s_sound');
    document.getElementById('setting-paused').innerText = t('setting_paused');
    document.getElementById('title-talent').innerText = t('title_talent');
    document.getElementById('title-pact').innerText = t('title_pact');
    document.getElementById('pact-desc').innerText = t('pact_desc');
    document.getElementById('btn-nodeal').innerText = t('btn_nodeal');

    if (selectedTalent) {
        let tal = TALENTS.find(t => t.id === selectedTalent);
        if (tal) {
            document.getElementById('hover-talent-name').innerText = t(tal.key);
            document.getElementById('hover-talent-desc').innerText = t(tal.desc);
        }
    }
    const pactIconEl = document.getElementById('ui-pact-icon');
    const pactInfoBox = document.getElementById('ui-pact-info');

    if (selectedPact) {
        let pact = PACTS.find(p => p.id === selectedPact);
        if (pact) {
            pactIconEl.innerText = pact.icon;
            pactIconEl.style.display = 'block';
            document.getElementById('hover-pact-name').innerText = t(pact.key);
            document.getElementById('hover-pact-desc').innerText = t(pact.desc);
            pactInfoBox.style.display = 'block';
        }
    } else {
        pactIconEl.style.display = 'none';
        pactInfoBox.style.display = 'none';
    }    

    if (currentBoss) {
        let prefix = (gameMode === 'pvp') ? 'player2' : currentBoss.id;
        let displayName = t('b_'+prefix);
        if(displayName.startsWith('b_')) displayName = t('boss_unknown');
        document.getElementById('boss-name-display').innerText = displayName;
        document.getElementById('boss-passive-display').innerText = t('p_' + prefix);
        document.getElementById('hover-demon-name').innerText = displayName;
        let descKey = 'desc_' + prefix;
        let descText = t(descKey);
        if (descText === descKey) descText = "No data available.";
        document.getElementById('hover-demon-desc').innerText = descText;
    } else {
        document.getElementById('boss-name-display').innerText = t('boss_unknown');
    }

    if (currentEvent) {
        document.getElementById('active-event-name').innerText = t('e_'+currentEvent.id);
        document.getElementById('tooltip-event-title').innerText = t('e_'+currentEvent.id);
        document.getElementById('tooltip-event-desc').innerText = t('ed_'+currentEvent.id);
        document.getElementById('splash-title').innerText = t('e_'+currentEvent.id);
        document.getElementById('splash-desc').innerText = t('ed_'+currentEvent.id);
    }

    if (isRussianRoulette) {
        document.getElementById('active-event-name').innerText = "ROULETTE";
        document.getElementById('splash-title').innerText = t('rr_trigger');
        document.getElementById('splash-desc').innerText = t('rr_desc');
   }

    updateAmmoTracker();
    renderItemsGrid();
    renderUI();
    updateAchievementsUI(); 
    checkSave();
}

function renderUI() {
    const drawHP = (pid, elId) => {
        let h = '';
        let styleClass = (pid === 1) ? 'you-active' : 'demon-active';
        for (let i = 0; i < maxHp[pid]; i++) {
            let shieldClass = (statusEffects[pid].shield > 0 && i < hp[pid]) ? 'shielded' : '';
            h += `<div class="hp-point ${i < hp[pid] ? styleClass : ''} ${shieldClass}"></div>`;
        }
        document.getElementById(elId).innerHTML = h;
        
        let lifeHtml = '';
        for (let j = 0; j < lives[pid]; j++) { lifeHtml += `<span class="life-heart life-active">â¤</span>`; }
        document.getElementById((pid === 1) ? 'lives-you' : 'lives-demon').innerHTML = lifeHtml;
    };
    
    drawHP(1, 'player-hp');
    drawHP(2, 'demon-hp');

    let showId = (gameMode === 'pve') ? 1 : currentTurn;
    ITEM_LIST.forEach(k => { 
        let el = document.getElementById('n-' + k);
        if (el) {
            let count = currentItems[showId][k] || 0;
            el.innerText = count;
            el.parentElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        let btn = document.getElementById('btn-item-'+k);
        if(btn) {
            btn.querySelector('.item-content').classList.remove('item-deceptive');
            btn.disabled = isRussianRoulette || !document.getElementById('btn-self').disabled ? false : true;
            if(gameLock) btn.disabled = true;
            
            if (selectedPact === 'eye' && currentItems[1][k] > 0 && showId === 1 && !isRussianRoulette) {
                if (Math.random() < 0.5) btn.querySelector('.item-content').classList.add('item-deceptive');
            }
        }
    });

    if(isRussianRoulette) {
        document.querySelectorAll('.item-btn').forEach(b => b.disabled = true);
        document.getElementById('btn-enemy').disabled = true;
    }

    if (gameMode === 'pve') {
        const eContainer = document.getElementById('enemy-items-display');
        eContainer.innerHTML = '';
        
        if (typeof mirrorSelectionMode !== 'undefined' && mirrorSelectionMode) {
            eContainer.style.border = "1px dashed var(--accent-purple)";
            eContainer.style.backgroundColor = "rgba(165, 94, 234, 0.1)";
            eContainer.style.borderRadius = "4px";
        } else {
            eContainer.style.border = "none";
            eContainer.style.backgroundColor = "transparent";
        }

        for (let item in currentItems[2]) {
            let count = currentItems[2][item];
            if (count > 0) {
                for(let c=0; c<count; c++) {
                    let div = document.createElement('div');
                    div.className = 'enemy-item-icon';
                    div.innerHTML = `${ITEM_ICONS[item]}<div class="enemy-item-tooltip"><b>${t('i_'+item)}</b><br>${t('d_'+item)}</div>`;
                    
                    if (typeof mirrorSelectionMode !== 'undefined' && mirrorSelectionMode) {
                        div.style.cursor = 'pointer';
                        div.style.boxShadow = '0 0 10px var(--accent-purple)';
                        div.style.animation = 'pulse 1s infinite';
                        
                        div.onclick = function() {
                            window.performMirrorSteal(item);
                        };
                    }

                    eContainer.appendChild(div);
                }
            }
        }
    }
}

function renderItemsGrid() {
    const area = document.getElementById('items-area'); area.innerHTML = '';
    ITEM_LIST.forEach(key => {
        let btn = document.createElement('button'); 
        btn.className = 'item-btn'; 
        btn.id = 'btn-item-'+key; 
        btn.onclick = () => useItem(key);
        btn.innerHTML = `<div class="item-content"><div class="item-icon">${ITEM_ICONS[key]}</div><div class="item-name">${t('i_'+key)}</div></div><div class="item-badge" id="n-${key}">0</div><div class="item-tooltip"><h4>${t('i_'+key)}</h4><p>${t('d_'+key)}</p></div>`;
        area.appendChild(btn);
    });
}

function updateAmmoTracker() {
    let live = magazine.filter(b => b === 1).length;
    let blank = magazine.filter(b => b === 0).length;
    let el = document.getElementById('ammo-tracker');
    
    if (currentEvent && (currentEvent.id === 'mist' || currentEvent.id === 'fog')) {
        el.innerText = `ã€ ??? | Total: ${magazine.length} ã€‘`;
        el.classList.add('fog-text');
    } else {
        el.innerText = t('ammo_fmt', { live, blank });
        el.classList.remove('fog-text');
    }
}

function updateHistoryUI() {
    const container = document.getElementById('history-display');
    container.innerHTML = '';
    let isHidden = (currentEvent && (currentEvent.id === 'mist' || currentEvent.id === 'fog')) || (selectedTalent === 'poker' && gameMode === 'pvp');
    if (isHidden) container.classList.add('hist-hidden'); else container.classList.remove('hist-hidden');

    historyLog.forEach(val => {
        let d = document.createElement('div'); d.className = 'hist-dot';
        if (val === 1) d.classList.add('hist-live');
        else if (val === 2) { d.classList.add('hist-unknown'); d.innerText = '?'; }
        else d.classList.add('hist-blank');
        container.appendChild(d);
    });
}

function renderChamberUI() {
    let container = document.getElementById('chamber-display'); container.innerHTML = '';
    for(let i=0; i < magazine.length; i++) {
        let k = chamberKnowledge[i];
        let div = document.createElement('div'); div.className = 'shell';
        if (i === magazine.length - 1) div.classList.add('next');
        if (k === 1) { div.classList.add('live'); div.innerText = 'ğŸ”¥'; } 
        else if (k === 2) { div.classList.add('blank'); div.innerText = 'ğŸ’¨'; } 
        else { div.innerText = '?'; }
        container.appendChild(div);
    }
}

function showItemToast(itemList, pid) {
    if (pid !== 1) return;
    const container = document.getElementById('toast-area');
    let counts = {}; itemList.forEach(i => counts[i] = (counts[i] || 0) + 1);

    for (let item in counts) {
        let card = document.createElement('div'); card.className = 'toast-card';
        card.innerHTML = `<div class="toast-icon">${ITEM_ICONS[item]}</div><div class="toast-info"><div class="toast-title">${t('toast_gain')}</div><div class="toast-name">${t('i_' + item)} x${counts[item]}</div></div>`;
        container.appendChild(card);
        setTimeout(() => { card.style.animation = 'toastFadeOut 0.4s ease-in forwards'; setTimeout(() => card.remove(), 400); }, 3000);
    }
}

function renderTalentSelection() {
    const box = document.getElementById('talent-grid-box'); box.innerHTML = '';
    let pool = [...TALENTS].sort(() => 0.5 - Math.random()).slice(0, 3);
    pool.forEach(tal => {
        let el = document.createElement('div'); el.className = 'talent-card'; el.onclick = () => selectTalent(tal.id);
        el.innerHTML = `<div class="talent-icon">${tal.icon}</div><div class="talent-title">${t(tal.key)}</div><div class="talent-desc">${t(tal.desc)}</div>`;
        box.appendChild(el);
    });
}

function renderItemSelection() {
    const grid = document.getElementById('starter-item-grid');
    grid.innerHTML = '';
    let pool = ALL_ITEM_LIST.filter(i => i !== 'feint' && i !== 'visor');

    pool.forEach(key => {
        let btn = document.createElement('div');
        btn.className = 'starter-select-btn';
        btn.id = 'starter-btn-' + key;
        btn.onclick = () => toggleStarterItem(key);
        btn.innerHTML = `
            <div style="font-size:1.5rem;">${ITEM_ICONS[key]}</div>
            <div style="font-size:0.5rem; color:#888;">${t('i_'+key)}</div>
        `;
        grid.appendChild(btn);
    });
    updateStarterConfirmBtn();
}

function updateStarterConfirmBtn() {
    const btn = document.getElementById('btn-confirm-items');
    btn.innerText = `CONFIRM (${starterItemsBuffer.length}/2)`;
    if (starterItemsBuffer.length > 0) {
        btn.style.opacity = 1;
        btn.style.pointerEvents = 'auto';
    } else {
        btn.style.opacity = 0.5;
        btn.style.pointerEvents = 'none';
    }
}

function renderPactSelection() {
    const box = document.getElementById('pact-grid-box'); box.innerHTML = '';
    let pool = [...PACTS].sort(() => 0.5 - Math.random()).slice(0, 3);
    pool.forEach(pact => {
        let el = document.createElement('div'); el.className = 'curse-card'; el.onclick = () => selectPact(pact.id);
        el.innerHTML = `<div class="talent-icon">${pact.icon}</div><div class="curse-title">${t(pact.key)}</div><div class="curse-desc">${t(pact.desc)}</div>`;
        box.appendChild(el);
    });
}

function toggleLanguage() { curLang = (curLang === 'zh') ? 'en' : 'zh'; renderLanguage(); }
function openSettings() { document.getElementById('settings-screen').style.display = 'flex'; document.getElementById('sound-toggle').checked = soundEnabled; }
function closeSettings() { document.getElementById('settings-screen').style.display = 'none'; }
function updateLog(txt) { document.getElementById('info-text').innerText = txt; }
function toggleSound() { soundEnabled = document.getElementById('sound-toggle').checked; }
function showHelp() { document.getElementById('help-screen').style.display = 'flex'; }
function closeHelp() { document.getElementById('help-screen').style.display = 'none'; }
function toggleTwist() { isTwisted = !isTwisted; document.getElementById('twist-toggle').classList.toggle('active'); renderLanguage(); }
function showMenu() { document.getElementById('overlay').style.display = 'none'; document.getElementById('menu-screen').style.display = 'flex'; checkSave(); }

function showAchievements() { document.getElementById('achieve-screen').style.display = 'flex'; updateAchievementsUI(); }
function closeAchieve() { document.getElementById('achieve-screen').style.display = 'none'; }

function updateAchievementsUI() {
    document.getElementById('achieve-btn').innerText = `ğŸ† ${unlockedAchieves.length}/${ACHIEVEMENTS.length}`;
    let list = document.getElementById('achieve-list-container'); list.innerHTML = '';
    ACHIEVEMENTS.forEach(a => {
        let unlocked = unlockedAchieves.includes(a.id);
        let div = document.createElement('div'); div.className = `achieve-item ${unlocked?'unlocked':''}`;
        div.innerHTML = `<div class="ach-icon">ğŸ†</div><div class="ach-info"><div>${t(a.key)}</div><div>${t(a.key.replace('ach','ad'))}</div></div>`;
        list.appendChild(div);
    });
}

function unlockAchievement(id) {
    if (!unlockedAchieves.includes(id)) {
        unlockedAchieves.push(id); localStorage.setItem('br_achievements', JSON.stringify(unlockedAchieves));
        let pop = document.getElementById('achieve-popup'); let data = ACHIEVEMENTS.find(a => a.id === id);
        document.getElementById('achieve-pop-name').innerText = t(data.key); pop.style.display = 'flex'; 
        setTimeout(() => pop.style.display = 'none', 3000); 
        updateAchievementsUI();
    }
}

function triggerTaunt(type) {
    if (!currentBoss || gameMode === 'pvp') return;
    if (Math.random() > 0.4) return;
    const quotes = BOSS_TAUNTS[currentBoss.id][type]; if (!quotes) return;
    const txt = quotes[Math.floor(Math.random() * quotes.length)];
    const bubble = document.getElementById('boss-taunt'); 
    bubble.innerText = txt; bubble.classList.add('show'); 
    setTimeout(() => bubble.classList.remove('show'), 3000);
}

function updateTurnUI() { renderLanguage(); }

function renderMirrorUI(active) {
    const overlay = document.getElementById('mirror-overlay');
    const enemyBox = document.getElementById('enemy-items-display');

    if (active) {
        overlay.style.display = 'block';
        enemyBox.classList.add('mirror-active-target');
    } else {
        overlay.style.display = 'none';
        enemyBox.classList.remove('mirror-active-target');
    }
}

window.cancelMirrorMode = function() {
    if (!mirrorSelectionMode) return;
    mirrorSelectionMode = false;
    currentItems[1]['mirror']++; 
    itemsUsedThisTurn--; 
    updateLog("ğŸ”® å·²å–æ¶ˆçªƒå–ã€‚");
    renderMirrorUI(false); 
    renderUI();
};

window.onload = function() {
    const gameContainer = document.getElementById('game-container');
    const gunDisplay = document.getElementById('gun-display');
    
    gameContainer.addEventListener('mousemove', (e) => {
        if (gameLock || document.getElementById('menu-screen').style.display !== 'none' || document.getElementById('settings-screen').style.display !== 'none') return;
        
        const rect = gameContainer.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const deltaX = (e.clientX - centerX) / (rect.width / 2);
        const deltaY = (e.clientY - centerY) / (rect.height / 2);
        
        gunDisplay.style.transform = `perspective(500px) rotateY(${deltaX * 15}deg) rotateX(${-deltaY * 10}deg)`;
    });
    
    gameContainer.addEventListener('mouseleave', () => {
        if (!gameLock) gunDisplay.style.transform = 'perspective(500px) rotateY(0deg) rotateX(0deg)';
    });
    
    renderItemsGrid(); checkSave();
};
    </script>
</body>
</html>